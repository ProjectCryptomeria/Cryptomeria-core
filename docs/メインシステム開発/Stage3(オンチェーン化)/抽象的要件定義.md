# 📑 モジュラー型・インターチェーン分散ストレージシステム 要件定義書

## 1\. システム概要

本システムは、データの「受付・分割（Execution）」、「管理（Metadata）」、「保存（Storage）」の役割を異なるブロックチェーンに分離した、インターチェーン構成の分散ファイルシステムである。

  * **アーキテクチャ:** 3層構造 (Router - Controller - Storage)
  * **主要コンポーネント:**
    1.  **GWC (Gateway Chain):** 揮発性のルーター。データの分割とIBC配送を担当。
    2.  **MSC (Metadata Storage Chain):** ファイルシステムの頭脳。ファイル名、バージョン管理、保存場所（マップ）を管理。
    3.  **DSC (Data Storage Chain):** 実データの保管庫。分割されたバイナリデータを永続保存する。

-----

## 2\. コンポーネント定義

### 🚀 2.1. GWC: Gateway Chain (ゲートウェイ・チェーン)

**役割:** ステートレスなシャーディング・ルーター

  * **主要機能:**
      * **Ingest (受信):** クライアントからファイルデータを含むトランザクションを受信。
      * **Sharding (分割):** 受信データを固定サイズ（例: 1KB）のチャンクに分割。
      * **Distribution (並列配送):**
          * **To DSC:** 分割したチャンクをIBCパケットとして複数のDSCへ送信。
          * **To MSC:** ファイル属性と「どのチャンクをどのDSCへ送ったか」のマッピング情報をIBCパケットとして送信。
      * **Logging (証跡):** 処理結果（レシート）をトランザクションイベントとして発行。
  * **データ保持ポリシー:**
      * **揮発性 (Ephemeral):** トランザクション処理完了後、データ本体（ペイロード）は保持しない。
      * **Pruning:** **Strict Pruned**（厳格な剪定）運用。
  * **ノード設定:**
    ```toml
    [pruning]
    pruning = "custom"
    pruning-keep-recent = "100"  # 最新100ブロックのみ保持
    pruning-keep-every = "0"     # アーカイブなし
    ```

### 🗂️ 2.2. MSC: Metadata Storage Chain (メタデータ・ストレージ・チェーン)

**役割:** バージョン管理機能付きカタログサーバー (NameNode)

  * **主要機能:**
      * **Indexing:** GWCから受信したメタデータ（ファイル名、サイズ、所有者）を記録。
      * **Versioning:** 同一名のファイルが送信された場合、自動的にバージョン番号をインクリメント（v1 -\> v2）して管理。
      * **Mapping:** 各バージョンが、具体的にどのDSCのどのIDに紐付いているかのマップを保持。
      * **Search Interface:** ユーザーからのファイル検索、バージョン履歴照会に応答。
  * **データ保持ポリシー:**
      * **永続性 (Persistent):** メタデータ履歴を完全に保持。
  * **ノード設定:**
    ```toml
    [pruning]
    pruning = "nothing"          # アーカイブノード運用
    ```

### 💾 2.3. DSC: Data Storage Chain (データ・ストレージ・チェーン)

**役割:** 不変のデータ保管庫 (DataNode)

  * **主要機能:**
      * **Blob Storage:** GWCから受信したバイナリチャンクをKVStoreに保存。
      * **Simple KV:** ファイル名やバージョンを意識せず、「ChunkID: Data」の形式で愚直に保存する。
  * **データ保持ポリシー:**
      * **永続性 (Persistent):** 一度書き込まれたデータは削除されない。
      * **復元性:** MSCのポインタに従い、過去の任意の時点のデータを払い出すことが可能。
  * **ノード設定:**
    ```toml
    [pruning]
    pruning = "nothing"          # アーカイブノード運用
    ```

-----

## 3\. データ処理フロー (Data Pipeline)

### 3.1. アップロードフロー (Write)

1.  **Client -\> GWC:**
      * `MsgUpload` を送信。（Payload: 10KB, Filename: "doc.txt"）
2.  **GWC Internal:**
      * メモリ上でデータを10個のチャンクに分割。
      * イベントログ `EmitEvent(Receipt)` を発行。
3.  **GWC -\> DSC (Data Route):**
      * 10個のIBCパケットを各DSCへ並列送信。
      * Content: `{ ChunkIndex, BinaryData }`
4.  **GWC -\> MSC (Meta Route):**
      * 1つのIBCパケットをMSCへ送信。
      * Content: `{ Filename, TotalChunks, TargetDSCs_List }`
5.  **Persistence (Finalize):**
      * **DSC:** バイナリを保存。
      * **MSC:** DBを照会し、バージョンを採番（v1 -\> v2）して保存。
6.  **Cleanup:**
      * GWCのPruningサイクルにより、10KBのペイロードは物理削除される。

### 3.2. ダウンロード・復元フロー (Read/Restore)

1.  **Client -\> MSC:**
      * 「"doc.txt" の最新版（またはv1）の場所を教えて」とクエリ。
2.  **MSC Response:**
      * 「Chunk1はDSC-1のID:aaa、Chunk2はDSC-2のID:bbb...」というマップを返却。
3.  **Client -\> DSCs:**
      * 各DSCに対して直接クエリを行い、バイナリ断片を取得。
4.  **Client Internal:**
      * 取得した断片を結合し、元のファイルを復元。

-----

## 4\. ノード運用・データライフサイクル比較表

| 特性 | GWC (Gateway) | MSC (Metadata) | DSC (Data) |
| :--- | :--- | :--- | :--- |
| **役割** | **ルーター** | **管理者 (脳)** | **倉庫 (体)** |
| **Pruning設定** | **Strict (Custom)** | **Archive (Nothing)** | **Archive (Nothing)** |
| **ディスク消費** | **一定** (揮発) | **低〜中** (増加) | **高** (増加) |
| **データ永続性** | なし (一時通過のみ) | あり (全履歴) | あり (全履歴) |
| **過去データ照会** | 不可 | **可能 (Version管理)** | **可能** |
| **拡張性** | 外部リスナーによるログ収集 | - | シャーディングによる台数追加 |

-----

## 5\. 拡張性と信頼性

### 5.1. レシート（証跡）の保存

  * GWCはステートに履歴を残さないが、監査が必要な場合は **Event Listener (Indexer)** を外部に設置する。
  * GWCから発行される `upload_receipt` イベントをリアルタイムで収集し、オフチェーンのDB（SQL等）や専用のログチェーンに保存することで、GWCを肥大化させずに証跡管理を行う。

### 5.2. 信頼性の担保モデル

  * **GWC:** 「現在」が正しく動いていることの証明（State Sync + 最新ブロックヘッダー検証）。
  * **MSC/DSC:** 「過去」の全てが保存されていることの証明（1-of-N アーカイブモデル）。ネットワーク内に最低1台のアーカイブノードが存在すれば、データの完全性は保証される。