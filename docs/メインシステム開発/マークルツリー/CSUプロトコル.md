# Cryptomeria Secure Upload Protocol (CSUプロトコル)

## 🔒 1. 脅威モデル：GWCおよびFDSCに対する不信

CSUプロトコルは、中央集権的なゲートウェイ（GWC）や分散ストレージ（FDSC）が悪意を持っている、あるいは攻撃を受けている可能性を前提とした「ゼロトラスト」モデルを採用しています。

### 🚨 想定される悪意のケース

* **GWCによる中間一致改ざん**: ユーザーがアップロードしたZIPファイルを展開し、不正なコード（バックドア等）を混入させた後に再圧縮して保存する行為。
* **GWCによる証跡の捏造**: 実際には改ざんしたデータを保存しているにもかかわらず、クライアントには「正しいデータに基づいたSiteRootである」と嘘をつき、署名を促す行為。
* **FDSCによるサイレント・データ汚染**: 保存された断片（Fragment）を後から書き換える、あるいは特定の断片のみを意図的に消失させる行為。
* **MDSCにおけるポインタの差し替え**: 目録（Manifest）情報を書き換え、ユーザーが意図したファイルとは別の断片IDを紐付ける行為。

---

## 🛡️ 2. CSUプロトコルによる対抗措置

今回の検証スクリプト（`ops/scripts/test/poc/integrity-test.sh`）では、以下の「多段能動検証」を行うことで上記悪意を数学的に封じ込めています。

* **分散データの直接回収検証（Stage 2）**: GWCのAPIを介さず、バックエンドの各FDSCから直接データをサンプリング取得してハッシュを計算します。これにより、配送後のデータ改ざんやマニフェストの捏造を検知します。
* **ローカル原本からの独立計算（Stage 3）**: インフラ側のロジックを一切信用せず、クライアント手元の「原本」から理論上の `SiteRoot` を自ら算出します。GWCが提示した値と1ビットでも異なれば、プロトコルは異常を検知し、署名を拒否します。

---

## 🔑 3. クライアントサイドの鍵管理と署名

* **秘密鍵の完全隔離**: クライアント（Alice）の秘密鍵は、トランザクション発行時も含め、一貫してクライアントのローカルサイドにのみ保持されます。GWC（リモート）へ秘密鍵が公開されることは一度もありません。
* **署名の生成**: クライアントは、自ら算出した理論値とGWCの提示値が一致したことを確認した後、その `SiteRoot`（サイト全体の構成を要約したハッシュ値）に対して自身の秘密鍵で署名を行います。
* **署名の意味**: この署名は「この `SiteRoot` が示す構成は、私の意図したものに間違いありません」という本人による公証（アテステーション）として機能します。

---

## 🏗️ 4. GWC（Go側）における検証メカニズムの提案

現在は実装待機状態（TODO）ですが、GWC側で以下の検証を実装することで、更新操作が間違いなく本人によるものであることを担保できます。

1. **公開鍵の取得**: アドレス（`Creator`）に対応する公開鍵を、チェーンの `auth` モジュールから取得、あるいはメッセージに添付された公開鍵がアドレスと一致するかを確認します。
2. **数学的署名検証**: `sdk.VerifySignature(PubKey, SiteRoot, Signature)` を実行し、送られてきた `SiteRoot` が本人の鍵で正しく計算されたものであるかを検証します。
3. **状態更新の承認**: 署名が正しい場合のみ、マニフェストの更新を MDSC へ IBC パケットとして送信します。

---

## 📐 5. 暗号学的仕様（ハッシュと構造）

プロトコルの決定論（誰が計算しても同じSiteRootになること）を保証する仕様です。

* **ハッシュアルゴリズム**: **SHA256** を使用します。
* **マークルツリー構造**: **Binary Merkle Tree** を採用し、要素数が奇数の場合は末尾の要素を複製してペアを作ります。
* **接頭辞（Prefix）によるドメイン分離**:
* **断片リーフ**: `SHA256("FRAG:{path}:{index}:{data_sha256}")`
* **ファイルリーフ**: `SHA256("FILE:{path}:{size}:{file_root_hash}")`


* **決定論的順序**: ファイルリストは必ず「パス名のアルファベット順」でソートしてから計算を開始します。

---

## ✨ 6. 追加の重要事項（セルフ監査性）

本プロトコルの最も強力な点は、**「検証スクリプトが誰でも実行可能である」**という点です。

* **第三者監査**: Alice 以外の第三者（監査ノードや一般ユーザー）も、公開されている `SiteRoot` と FDSC の実データを照合することで、「このサイトの内容は、Alice が署名した時のものから一切変わっていないか」をいつでも数学的に確認できます。
* **証跡の永続性**: 署名付きの `SiteRoot` がブロックチェーン（MDSC）に記録されることで、過去のどの時点において、どのような構成のデータが正しいとされていたかの履歴が改ざん不能な形で残ります。