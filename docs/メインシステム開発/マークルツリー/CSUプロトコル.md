# 🛡️ CSUプロトコル 仕様書（更新版）

## 🔒 1. 脅威モデル：GWCおよびFDSCに対する不信

CSUプロトコルは、中央集権的なゲートウェイ（GWC）や分散ストレージ（FDSC）が悪意を持っている、あるいは攻撃を受けている可能性を前提とした「ゼロトラスト」モデルを採用しています。

### 🚨 想定される悪意のケース

* **GWCによる中間一致改ざん**: ユーザーがアップロードしたファイルを展開し、不正なコードを混入させた後に再圧縮して保存する行為。
* **GWCによる証跡の捏造**: 実際には改ざんしたデータを保存しているにもかかわらず、クライアントには「正しいデータに基づいたSiteRootである」と嘘をつく行為。
* **FDSCによるサイレント・データ汚染**: 保存された断片（Fragment）を後から書き換える、あるいは特定の断片のみを意図的に消失させる行為。
* **MDSCにおけるポインタの差し替え**: 目録（Manifest）情報を書き換え、ユーザーが意図したファイルとは別の断片IDを紐付ける行為。

---

## 🛡️ 2. CSUプロトコルによる対抗措置

検証スクリプトや実装コードでは、以下の「多段能動検証」を行うことで上記悪意を数学的に封じ込めています。

* **分散データの直接回収検証**: GWCのAPIを介さず、バックエンドの各FDSCから直接データをサンプリング取得してハッシュを計算し、捏造を検知します。
* **ローカル原本からの独立計算**: クライアントは手元の原本から `SiteRoot` を算出し、GWCが提示した値と1ビットでも異なれば署名を拒否します。

---

## 🏗️ 3. GWC（オンチェーン）における署名検証仕様

GWC側では、クライアントから送られた署名が正しいことを、以下のロジックで厳格に検証します。

### 🕒 検証のタイミング

* **`MsgSignUpload` トランザクションの実行時**: クライアントが `CompleteUpload` で発行された `SiteRoot` を確認し、署名を付与して送信した直後に検証が行われます。

### ⚙️ 検証ステップと方法

1. **公開鍵の動的取得**: メッセージに含まれる `Creator` アドレスを元に、チェーンの `auth` モジュール（AccountKeeper）から最新の公開鍵（PubKey）を抽出します。
2. **ハッシュ一致確認**: GWCのステート（`UploadSessionResult`）に保存されている、サーバー側で計算した `SiteRoot` と、メッセージ内の `SiteRoot` が完全に一致することを確認します。
3. **数学的署名検証**: 取得した公開鍵を使用し、`pubKey.VerifySignature(siteRootBytes, Signature)` を実行します。これにより、署名が「そのSiteRootに対して」「本人の秘密鍵で」生成されたものであることが保証されます。
4. **処理の継続**: 検証が成功した場合のみ、IBCによる各ストレージチェーン（FDSC/MDSC）へのデータ配送を開始します。失敗した場合は例外なくエラーを返し、処理を中断します。

---

## 🔑 4. クライアントサイドの鍵管理

* **秘密鍵の完全隔離**: クライアントの秘密鍵は一貫してローカルサイドにのみ保持されます。GWCへ秘密鍵が送信されることはありません。
* **署名の意味**: この署名は「この `SiteRoot` が示す構成は、私の原本と一致しており、改ざんされていないことを認めます」という本人の公証（アテステーション）として機能します。

---

## 📐 5. 暗号学的仕様（ハッシュと構造）

プロトコルの決定論（誰が計算しても同じSiteRootになること）を保証する仕様です。

* **ハッシュアルゴリズム**: **SHA256** を使用します。
* **マークルツリー構造**: **Binary Merkle Tree**。要素数が奇数の場合は末尾を複製します。
* **接頭辞（Prefix）によるドメイン分離**:
* **断片リーフ**: `SHA256("FRAG:{path}:{index}:{data_sha256}")`
* **ファイルリーフ**: `SHA256("FILE:{path}:{size}:{file_root_hash}")`


* **決定論的順序**: ファイルリストは必ず「パス名のアルファベット順」でソートしてから計算します。

---

## ✨ 6. セルフ監査性

* **第三者監査**: 公開されている `SiteRoot` と FDSC の実データを照合することで、第三者もデータの完全性を数学的に確認可能です。
* **証跡の永続性**: 署名付きの `SiteRoot` が MDSC に記録されることで、過去のどの時点においてどのデータが正当であったかの履歴が改ざん不能な形で残ります。