# 要件定義書 v3.3 - モジュラー型インターチェーンWEBホスティング

> v3.2 からの主な変更点（要旨）
> - Read経路を **HTTP→GWC→(MDSC/FDSC参照)→HTTPレスポンス** に統一（ブラウザ直問い合わせを廃止）
> - Uploadは **HTTPでGWCサイドカーへ投入 → サイドカーが分割Tx化 → GWC → IBCでFDSC/MDSC** に整理
> - GWCは **state保持 / ブロック履歴は短期保持**（保持期間は **Relayer最大停止時間×安全率**で設計）
> - フラグメントサイズは **MB級（例：1〜10MB）** を前提にし、断片爆発を回避
> - 再送・重複排除は **決定的ID（冪等キー）** と **Conflict拒否**（同IDで内容が違えば拒否）で簡素化
> - 公開時点は **MDSCでManifestが確定したブロック高/時刻** に固定（Manifest内timestampは参照用）
> - WebホスティングのMVP要件（index/Content-Type/404/バイナリ返却）を明文化
> - Relayer運用責務を **PoCは運用者** に固定

---

## 1. はじめに

### 1.1. 背景・目的

#### 1.1.1. 目的
本システムは、Cosmosエコシステムのモジュラー性を活用し、WEBリソースをブロックチェーン上に永続的に保存・配信する「オンチェーンWEB」システムのPoCを行うことにある。  
従来のモノリシックなブロックチェーンストレージとは異なり、**「受付(Execution)」「管理(Metadata)」「保存(Storage)」**の役割を異なるチェーンに分離し、スケーラビリティとデータの永続性を両立させる。

#### 1.1.2. 背景
DAppsの普及に伴い、フロントエンドの永続性欠如（サーバーダウンやリンク切れ）が課題となっている。既存のオンチェーンストレージはコストや速度の面でWebホスティングには不向きであり、Internet Computerのような巨大な独自エコシステムは移植性に欠ける。  
そこで本システムでは、Cosmos SDKとIBCを用いた「インターチェーン分散ファイルシステム」を構築し、軽量かつ汎用的なWebホスティング基盤を提案する。

---

## 2. システム概要

本システムは、3層のブロックチェーン群によって構成される分散ストレージネットワークである。  
クライアント（ブラウザ）は `http://cryptomeria.com/<ProjectName>/<path>` にアクセスするだけで、GWCが必要なデータを収集しブラウザ互換のHTTPレスポンスを返す。

### 2.1. アーキテクチャコンセプト

- **GWC (Gateway Chain) / Router**
  - Upload受付、分割Tx生成の起点（サイドカーと連携）、IBC配送
  - Read時は MDSC/FDSC を参照して復元し、HTTPで配信する
  - **stateは保持**し、**古いブロック履歴は短期保持**とする

- **MDSC (ManifestData Storage Chain) / Index**
  - Projectの構成（Manifest）とバージョン管理
  - 公開の確定点（公開時点は MDSC の確定ブロックで定義）

- **FDSC (FragmentData Storage Chain) / Body**
  - MB級の断片データ（Fragment/Part）を保存（KV）
  - Project構造は知らない

### 2.2. 用語定義

- **GWC (Gateway Chain)**：Upload受付、分割、IBC配送、HTTP配信（Read）を担うチェーン
- **GWC Sidecar**：GWC近傍で動作するコンポーネント。大容量フォルダをHTTPで受け取り、分割Txを生成してGWCへ送信する
- **MDSC (ManifestData Storage Chain)**：ManifestとVersionを永続管理するチェーン
- **FDSC (FragmentData Storage Chain)**：断片データ（MB級）をKVで永続管理するチェーン
- **IBC (Inter-Blockchain Communication)**：チェーン間のパケット転送プロトコル
- **Project / Asset / EntryPoint**：
  - ProjectNameをURLネームスペースとし、配信対象のファイル集合（フォルダ）を管理単位とする  
  - EntryPointはMVPとして `index.html` を標準とする

---

## 3. 基本要件

### 3.1. 利害関係者
- **デプロイヤー（ホスト）**：コンテンツをアップロードするユーザー
- **ビューワー（クライアント）**：Webページを閲覧するユーザー（ブラウザ）
- **デベロッパー（運用者）**：システム運用者（relayer運用含む）

### 3.2. スコープ
- **Scope In**
  - Upload：フォルダ（プロジェクト）を投入し、分割・分散保存する
  - Read：HTTPリクエストに対し、復元したリソースをHTTPレスポンスとして返す
  - Project単位でのバージョニング管理（Semantic Versioning）
- **Scope Out**
  - 物理削除（論理削除/バージョン切替のみ）
  - サーバーサイド動的実行

---

## 4. 機能要件

## 4.1. コンポーネント詳細

### 4.1.1. GWC (Gateway Chain)
#### 役割
- Upload：受付、分割、IBC配送（FDSC/MDSCへ）
- Read：MDSC/FDSC参照、復元、HTTP配信

#### Upload（受付）
- クライアントは **フォルダ（プロジェクト）をHTTPでGWC Sidecarへ送信**する（大容量対応）
- Sidecarは受領したフォルダをスナップショット化し、内部で分割処理を行う

#### Read（HTTP配信）
- ブラウザのHTTPリクエストを受け取り、MDSCからManifestを取得
- Manifestの指示に基づき、FDSCから断片を取得し復元してHTTPレスポンスとして返す

---

### 4.1.2. GWC Sidecar
#### 役割
- 大容量フォルダの受領（HTTP）
- フォルダのスナップショット化（アップロード中に内容が変わらないように固定）
- MB級断片への分割（B.1）
- 分割Txの生成と送信（GWCへ）

#### 分割サイズ
- 断片（Part/Fragment）サイズは **MB級（例：1〜10MB）** を標準とする  
  ※旧1KB〜10KBは断片数が爆発するため採用しない

---

### 4.1.3. MDSC (ManifestData Storage Chain)
#### 役割
- Project単位のManifest保存
- Versioning（最新版解決、SemVer）
- 公開確定点の提供

#### 公開時点の定義（E.1）
- **公開時点 = MDSCにて対象VersionのManifestが確定したブロック高/時刻**
- Manifest内timestampは参照用とし、監査根拠はMDSC確定ブロックを優先する

---

### 4.1.4. FDSC (FragmentData Storage Chain)
#### 役割
- 断片（MB級）をKVに保存するBlobストレージ
- Project構造は保持しない

#### 冪等性ルール（C.1）
FDSCは `part_id` をキーとし、以下のルールで受理する：

- **同じIDが無い**：保存（Tx処理）
- **同じIDで内容が同じ**：スルー（成功扱い）
- **同じIDで内容が違う**：拒否（Conflict）

> Conflict時は「先に確定した内容を正」とする。更新・差替えは新Version/新upload_idで行う。

---

## 4.2. データ処理フロー

### 4.2.1. アップロードフロー（Write）

#### 概要
- クライアントはフォルダをHTTPでSidecarへ送る
- Sidecarが分割Tx化してGWCへ投入
- GWCがIBCでFDSCへ断片を保存し、MDSCへManifestを保存
- MDSCのManifest確定により「公開」される（プロジェクトが読み出し可能になる）

#### ステージ（状態）
- **Staging（未公開）**：断片は集まりつつあるが、Manifestが未確定の状態
- **Published（公開済）**：Manifest確定済みで読み出し可能な状態

| ステップ | 担当 | アクション | 備考 |
|---|---|---|---|
| 1 | Client → Sidecar | プロジェクトフォルダをHTTP送信 | 大容量対応 |
| 2 | Sidecar | スナップショット化＆分割（MB級） | 1〜10MB想定 |
| 3 | Sidecar → GWC | 分割Txを送信 | 結果不明時は同IDで再送可能 |
| 4 | GWC → FDSC | IBCで断片保存 | FDSCは冪等ルール適用 |
| 5 | GWC → MDSC | IBCでManifest登録 | Manifest確定で公開 |
| 6 | MDSC | Manifest確定 | 公開時点 |

---

### 4.2.2. ダウンロード・閲覧フロー（Read）

#### 概要
- ブラウザはGWCへHTTPアクセス
- GWCはMDSCからManifest取得
- Manifestに基づきFDSCから断片を取得し復元
- ブラウザ互換のHTTPレスポンスを返す

| ステップ | 担当 | アクション |
|---|---|---|
| 1 | Browser → GWC | `/<ProjectName>/<path>` をHTTP GET |
| 2 | GWC → MDSC | 対象VersionのManifest取得（省略時は最新版） |
| 3 | GWC → FDSC群 | 断片を取得（必要に応じ並列） |
| 4 | GWC | 断片を結合し復元 |
| 5 | GWC → Browser | `Content-Type`等を付けてHTTPレスポンス |

---

## 4.3. データ構造要件

### 4.3.1. Manifest（MDSC保存）
- Project全体のスナップショット
- `files[path]` に断片リストを保持（復元順序は `part_index` で担保）
- `creator` を保存（所有権/更新権限の根拠）
- `published_at` は参照用（正はMDSC確定ブロック）

```json
{
  "project_name": "example.com",
  "version": "1.0.0",
  "creator": "cosmos1...",
  "published_at": "2026-01-14T00:00:00Z",
  "files": {
    "index.html": {
      "mime_type": "text/html",
      "size": 12345,
      "parts": [
        { "part_index": 0, "fdsc_id": "chain-1", "part_id": "u123:index.html:0" },
        { "part_index": 1, "fdsc_id": "chain-2", "part_id": "u123:index.html:1" }
      ]
    }
  }
}
````

### 4.3.2. Part/Fragment（FDSC保存）

* `part_id` は決定的ID（`upload_id + path + part_index` など）
* `value` はバイナリ（base64等）を保持

```json
{
  "key": "u123:index.html:0",
  "value": "base64_encoded_binary_data..."
}
```

---

## 4.4. 更新（Update）要件

* 公開済みVersionのManifestおよび参照断片は**不変**とする
* 変更（ファイル追加/上書き/削除相当）は **Updateトランザクション**により新Versionとして登録する
* 最新版の指す先はMDSCのVersion解決ロジックで決定する

---

## 5. 非機能要件

### 5.1. 可用性・拡張性

* FDSCの追加により保存容量/帯域の拡張を行う
* 大容量UploadはSidecarで分割し、Tx/IBCを分散させる

### 5.2. 運用・保守

#### GWCの保持方針（D.1）

* **stateは保持**
* **ブロック履歴は短期保持**
* 保持期間は **Relayer最大停止時間×安全率** に基づき設定する
  （Relayerが単一障害点になり得るため）

#### Relayer運用（PoC）

* Relayerは運用者が稼働させる
* 停止時の復旧手順と監視（アラート）を運用要件に含める

### 5.3. 性能

* Sidecarの分割・Tx生成・送信をボトルネックとして監視する
* Read時はGWC側で並列取得・復元を行いレイテンシを抑える

---

## 6. Web互換性（MVP要件）

* ルーティング：

  * `/<ProjectName>/` は `index.html` を返す（存在しない場合は404）
  * `/<ProjectName>/<path>` はManifestの `files[path]` を返す
* `Content-Type` はManifestの `mime_type` に従う
* バイナリはそのまま返す（画像/JS/CSS等）
* 未存在は404を返す

---

## 7. 制約条件

* Cosmos SDKで構築
* IBC準拠
* コアロジックはGo
* 閲覧者は標準ブラウザで完結（専用ウォレット必須等を課さない）
