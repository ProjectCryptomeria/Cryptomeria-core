---
DocType: GUIDE
SourceOfTruth: code
Status: draft
LastReviewed: 2026-01-25
Owners: TBD
---

# Use-case Flows（Upload / Download / Web Hosting）

## 1. 目的
利用者・開発者が「何がどの順で起きるか」を追えるように、代表ユースケースの詳細フローを記述します。
この文書は **コードが正**（実装追随）です。

## 2. 共通前提（すべてのユースケース共通）
- k8s 上で GWC/MDSC/FDSC-*/Relayer が稼働している
- IBC 接続が確立されている
- **GWC に endpoint registry が登録済み**（MDSC/FDSC の API URL）
  - 例：`ops/scripts/control/connect-chain.sh` が接続 + 登録を行う

## 3. Upload（CSU セッション方式）
> 注意：古いスクリプトで `gwcd tx gateway upload` を呼んでいる例があるが、現行は **CSU コマンド列（init/commit/distribute/finalize）** を組み合わせる設計。

### 3.1 正常系（概略）
1) **セッション開始**  
   - `gwcd tx gateway init-session [executor] [fragment-size] [deadline]`
2) **オフチェーンで分割・proof計算**  
   - ファイルを fragment_size で分割
   - fragment/file proof を作成（Merkle tree）
   - root_proof を得る
3) **root_proof をコミット**  
   - `gwcd tx gateway commit-root-proof [session-id] [root-proof-hex]`
4) **fragment を分散配送**（複数回可）  
   - `gwcd tx gateway distribute-batch [session-id] [items.json]`
   - items.json は path/index/fragment_bytes_base64/proof を含む
5) **manifest を送信してクローズ**  
   - `gwcd tx gateway finalize-and-close [session-id] [manifest.json]`
   - MDSC ACK 成功で CLOSED_SUCCESS

### 3.2 失敗系
- distribute で proof 不正：GWC が拒否（再計算/再送）
- FDSC 側 conflict：ACK failure（同一keyに異なるデータ）→ セッション失敗
- MDSC への manifest 保存失敗：ACK failure → セッション失敗
- relayer 停止：ACK/timeout → 最終クローズが遅延/失敗

### 3.3 観測ポイント
- GWC セッション状態（ログ/クエリ）
- pending packet / ack（relayerログ）
- MDSC/FDSC の API で manifest/fragment が見えるか

## 4. Download（CLI）
### 4.1 正常系
1) `gwcd q gateway endpoints` で endpoint 一覧取得（必要なら）
2) `gwcd q gateway download [filename] --project [project] --save-dir [dir]`
   - GWC が endpoint を解決し、MDSC から manifest を取得
   - manifest の fragments 指示に従って各 FDSC から fragment を取得
   - fragment を結合してファイル復元し保存

### 4.2 失敗系
- endpoint 未登録：解決できず失敗
- manifest 不在：MDSC から取得できず失敗
- fragment 欠損：復元不可（欠損検出として失敗）
- FDSC API 不達：タイムアウト/失敗

### 4.3 観測ポイント
- GWC の endpoints クエリ結果
- MDSC API の manifest レスポンス
- FDSC API の fragment レスポンス

## 5. Web Hosting（/render）
### 5.1 正常系
1) `GET /render/{project}/{version}/{path...}` を GWC に投げる
2) GWC が endpoint registry から MDSC/FDSC を解決
3) MDSC から manifest を取得し、対象 path の fragments を取得
4) fragments を復元してレスポンスとして返す

### 5.2 失敗系
- endpoint 未登録：解決失敗
- manifest 不整合：対象 path が存在しない
- fragment 欠損：復元失敗

## 6. 最小コマンド集（例）
- システム接続（クラスタ内前提）：`just start-system`
- endpoints：`gwcd q gateway endpoints`
- download：`gwcd q gateway download index.html --project myproj --save-dir /tmp`

