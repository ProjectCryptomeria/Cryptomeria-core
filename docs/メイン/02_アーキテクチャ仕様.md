---
DocType: SPEC
SourceOfTruth: doc
Status: draft
LastReviewed: 2026-01-25
Owners: TBD
---

# Architecture & Invariants

## 1. 目的
本書は Cryptomeria-Core の構造（レイヤー/コンポーネント/データ）と、設計上の不変条件を定義します。

## 2. レイヤー分割と責務境界
### 2.1 Deploy レイヤー
- k8s/helm によるデプロイ
- genesis 生成と配布
- IBC 接続の確立（relayer 設定/起動）
- GWC への endpoint 登録（参照解決に必須）

### 2.2 System レイヤー
- チェーン（GWC/MDSC/FDSC-*）の状態機械と検証
- IBC パケットの定義と ACK/timeout の意味
- manifest / fragment の保存・参照の規約
- Web hosting / download の参照解決ロジック

### 2.3 Client レイヤー
- 利用者が実行する CLI/HTTP 操作
- 実験プロトコルの実行とデータ収集
- （将来）コントローラ（自動アップロード等）の実行

## 3. コンポーネントの責務
### 3.1 GWC（Gateway Chain）
- CSU session 管理（init/commit/distribute/finalize/close）
- fragment を FDSC-* に分散配送（round-robin + 明示指定）
- manifest を MDSC に送信
- endpoint registry（MDSC/FDSC の API URL）を保持
- download/hosting で endpoint を解決し、復元を行う

### 3.2 MDSC（MetaData Store Chain）
- manifest の保存・更新（project/version/path の体系）
- manifest の提供（復元に必要）

### 3.3 FDSC-*（File Data Store Chain）
- fragment の保存（session_id + path + index 由来の識別）
- fragment の提供（復元に必要）
- conflict 検出（同一 key に異なる data が来た場合）

### 3.4 Relayer
- IBC の中継（接続維持/packet relay）

## 4. データモデル（概観）
### 4.1 Project / Version / Path
- **Project**：論理単位（例：ホスティング対象サイト、実験対象データセット）
- **Version**：同一プロジェクトの世代（immutable を推奨）
- **Path**：ファイルパス（復元/ホスティングのアドレス）

### 4.2 Fragment
- 1ファイルを一定サイズに分割したデータ片
- (path, index) で順序が決まり、復元は index 順に concat する

### 4.3 Manifest
- `files[path] -> {mime_type, size, fragments[], file_root, ...}`
- fragments[] は `{fdsc_id, fragment_id}` を含み、どの FDSC にあるかを示す

### 4.4 CSU Session
- アップロード全体をまとめる単位
- root_proof（全体の整合性）を最終的に固定する
- executor（実行者）と owner（所有者）を持つ

### 4.5 Endpoint Registry
- GWC が保持する `StorageInfo` の集合
- (channel_id, chain_id, api_endpoint, connection_type=mdsc|fdsc) を保持

## 5. 主要インタフェース
### 5.1 On-chain state
- GWC：Session state / StorageInfos / Params
- MDSC：Manifest state
- FDSC：Fragment state

### 5.2 Off-chain interface
- GWC HTTP `/render/{project}/{version}/{path...}`
- GWC CLI `gwcd q gateway download ...`
- 各チェーン API（1317）から manifest/fragment を取得（参照解決用）

## 6. 不変条件（Invariants）
- **I1**：Download/Hosting の復元は「Manifest → fragments」を唯一の根拠とする
- **I2**：Fragment の整合性は proof 検証により担保される（保存先を盲信しない）
- **I3**：同一 (session_id, path, index) の fragment は冪等である（同一なら重複OK）
- **I4**：FDSC-* の増加は分散先を増やし、負荷を低減しうる（分散戦略が仕様）
- **I5**：MDSC は manifest の“参照の正”である（復元の起点）

## 7. 失敗モデルと方針（概要）
- ACK 失敗/timeout：セッションは失敗として閉じられる（詳細は Protocol Spec）
- fragment conflict：保存拒否/エラーとして扱う（仕様固定推奨）
- relayer停止：一時的な遅延として扱い、復旧後に処理継続可能

## 8. スケーリング設計（FDSC-*）
- FDSC は `fdsc-0, fdsc-1, ...` のように増やす
- GWC は登録済み datastore channel を列挙し、配送先を選択する
- 増設後は relayer 再設定 + IBC 接続 + endpoint 登録が必要（Deploy/ops が担当）

## 9. 互換性とバージョニング
- Protocol 変更は原則破壊的になりやすい（CSU/packet schema）
- 変更時は “互換性の扱い” を Protocol Spec に明記し、Use-case も追随更新する

## 10. 実装への対応（現状）
- Deploy：`ops/infra/k8s/helm/cryptomeria/`, `ops/scripts/control/*`
- System：`apps/gwc`, `apps/mdsc`, `apps/fdsc`, `apps/relayer`
- Client：`apps/gwc` の CLI/HTTP、`ops/scripts/test/poc/*`（※一部古い可能性あり）
