---
DocType: GUIDE
SourceOfTruth: code
Status: draft
LastReviewed: 2026-01-25
Owners: TBD
---

# Deployment & Operations Guide

## 1. 目的
k8s/helm でシステムを立ち上げ、`start-system` により“利用可能な状態”へ持っていくまでをまとめます。
この文書は **コードが正**（chart/スクリプト追随）です。
内部構造や仕組みの詳細は `11_デプロイシステム詳細.md` を参照してください。

## 2. 前提
- kubectl / helm / just が利用可能
- ローカルなら kind/minikube 等（任意）
- Docker イメージ `cryptomeria/{gwc,mdsc,fdsc,relayer}:latest` を用意

## 3. ビルド（任意・開発用）
- チェーンバイナリ：`just dev::build-chain-all`
- イメージ：`just dev::build-image-all`
- ホットリロード：`just dev::hot-reload gwc` 等

## 4. Helm デプロイ（例）
Chart: `ops/infra/k8s/helm/cryptomeria`

```bash
# namespace作成込み（推奨）
kubectl create namespace cryptomeria || true

# install
helm install cryptomeria ops/infra/k8s/helm/cryptomeria -n cryptomeria

# values を指定したい場合
helm install cryptomeria ops/infra/k8s/helm/cryptomeria -n cryptomeria -f ops/infra/k8s/helm/cryptomeria/values.yaml
```

## 5. ポート設計（NodePort）
values.yaml のルール：
- grpc: base + 0
- api : base + 3
- rpc : base + 7

例（デフォルト）：
- GWC：30000/30003/30007
- MDSC：30010/30013/30017
- FDSC-0：30020/30023/30027
- FDSC-1：30030/30033/30037

## 6. 永続化（PVC）
- GWC/MDSC/FDSC/relayer それぞれ PVC を持つ（サイズは values.yaml）
- StatefulSet のデータはローリング更新でも保持される

## 7. genesis-server
- initContainers で各チェーンを起動して genesis を生成
- nginx が genesis を配布
- 各チェーン起動は genesis-server を参照して bootstrap される

## 8. “使える状態”へ（IBC接続 + endpoint登録 + relayer起動）
`just start-system` は以下を順に実行します：
1) relayer 設定初期化：`ops/scripts/control/init-relayer.sh`
2) 全チェーン接続：`ops/scripts/control/connect-all.sh`
3) relayer 起動：`ops/scripts/control/start-relayer.sh`

## 9. FDSC スケール（増減）
- `just chain::scale-fdsc 3` のように増やす
- スクリプトは（概ね）以下を実施：
  - helm upgrade で replicas を変更
  - relayer 再設定
  - 新 FDSC との IBC 接続
  - GWC に endpoint 登録（参照解決に必須）

## 10. 状態確認（ユーティリティ）
- `just chain::status`
- `just chain::network`
- `just chain::health`
- `just chain::logs gwc`

## 11. 典型的な落とし穴
- namespace/release 名の不一致（endpoint DNS 生成に影響）
- NodePort 競合（ローカル環境で他サービスと被る）
- relayer が Ready になっていない状態で connect を走らせる
- endpoint 未登録のまま download/hosting を試す（解決できない）
