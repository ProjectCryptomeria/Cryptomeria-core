---
DocType: SPEC
SourceOfTruth: doc
Status: draft
LastReviewed: 2026-01-25
Owners: TBD
---

# Protocol Spec（Cryptomeria 独自機構）

## 1. 目的
本書は “Cryptomeria-Core 独自の仕組み” を仕様として固定します。
- **CSU session**
- **Merkle proof / root proof**
- **IBC packet（fragment/manifest）**
- **Endpoint registry**
- ACK/timeout/失敗時の意味

## 2. 用語
- **Owner**：データ所有者（セッション作成者）
- **Executor**：アップロード操作を実行する主体（クライアント/コントローラ）
- **Session**：アップロード単位（CSU）
- **Fragment**：分割データ
- **Manifest**：参照解決情報

## 3. CSU Session 状態遷移（規範）
### 3.1 状態
- `INIT`：セッション作成直後
- `ROOT_COMMITTED`：root_proof が確定
- `DISTRIBUTING`：fragment 配送中
- `FINALIZING`：manifest 送信中
- `CLOSED_SUCCESS`：MDSC ACK 成功でクローズ
- `CLOSED_FAIL`：失敗（ACK失敗/timeout/abort）

### 3.2 遷移
1) `MsgInitSession(owner, executor, fragment_size, deadline)`  
   - INITへ
2) `MsgCommitRootProof(owner, session_id, root_proof)`  
   - ROOT_COMMITTEDへ
3) `MsgDistributeBatch(executor, session_id, items[])`（複数回可）  
   - DISTRIBUTING（配送が進む）
4) `MsgFinalizeAndCloseSession(executor, session_id, manifest)`  
   - FINALIZING（MDSCへ送信）
5) `OnAcknowledgement(manifest_packet)`  
   - success → CLOSED_SUCCESS  
   - failure → CLOSED_FAIL（reasonを記録推奨）
6) `MsgAbortAndCloseSession(executor, session_id, reason)`  
   - 即時 CLOSED_FAIL

> 規範：**CLOSED_SUCCESS は MDSC の ACK 成功でのみ成立**する。

## 4. Merkle / Proof 規約
### 4.1 ドメイン分離
- fragment leaf / file leaf / root の計算は、用途ごとに domain separation を行う
- 具体的なハッシュ関数・prefix は実装に追随しつつ、互換性が必要な場合は固定する

### 4.2 Proof 検証
- `MerkleProof.steps[]`（sibling, left/right）で root まで到達すること
- `MsgDistributeBatch` 時に、GWC は proof を検証してから配送する（検証不能なら拒否）

## 5. IBC Packet 仕様（概要）
### 5.1 FragmentPacket（GWC → FDSC）
- 主目的：fragment を datastore に保存する
- 含むべき情報（規範）：
  - session_id
  - path
  - index
  - fragment_bytes
  - fragment_proof（rootへの到達を証明）
  - file_proof / file_size（必要なら）

### 5.2 ManifestPacket（GWC → MDSC）
- 主目的：manifest を metastore に保存する
- 含むべき情報（規範）：
  - project_name
  - version
  - files（path→metadata）
  - root_proof
  - fragment_size
  - owner
  - session_id

### 5.3 ACK と Timeout
- FDSC ACK：保存の可否（success / conflict / invalid）
- MDSC ACK：manifest 保存の可否（success / invalid / rejected）
- timeout：relayer/接続不調等で ACK が返らなかった場合
  - 規範：timeout は CLOSED_FAIL の原因になりうる（再実行戦略は Client/Use-case で定義）

## 6. 分散配送（FDSC 選択規則）
- `target_fdsc_channel` 指定がある場合：その FDSC に送る
- 指定がない場合：登録済み datastore channel の集合から選ぶ（例：round-robin）
- 規範：FDSC 増設後、**接続 + endpoint 登録**が完了して初めて分散先に含める

## 7. Manifest 更新規則（MDSC）
- 同一 project_name の下で version をキーに保持
- `files[path]` は上書きまたはマージ（規範として決める：immutable version 推奨）
- 保存は冪等であるべき（同一 manifest の再送は成功）

## 8. Endpoint Registry（GWC）
### 8.1 StorageInfo
- channel_id：IBC channel
- chain_id：識別子（例：mdsc, fdsc-0）
- api_endpoint：`http://...:1317` 形式を推奨
- connection_type：`mdsc` または `fdsc`

### 8.2 登録
- Local admin が `MsgRegisterStorage` を発行して登録/更新する
- Deploy レイヤーの接続スクリプトが登録を自動化する

## 9. セキュリティ/整合性の保証範囲
- “改ざん検出” は proof により可能（保存先を信用しない）
- “可用性” は構成依存（FDSC増設/relayer冗長化等で改善）

## 10. 変更ルール
- 本書（SPEC）を変更する場合は、互換性の影響を必ず明記する
- Use-case/Deploy/Client も同時更新し、整合を保つ
