---
DocType: REFERENCE
SourceOfTruth: code
Status: draft
LastReviewed: 2026-01-25
Owners: TBD
---

# Deployment System Details

## 1. 目的
本ドキュメントは、Cryptomeria-Core のデプロイシステム（Kubernetes/Helm/Just）の内部構造と動作原理を詳細に解説します。
`05_デプロイ・運用ガイド.md` が「手順」に焦点を当てているのに対し、本書は「仕組み」に焦点を当て、トラブルシューティングやカスタマイズに必要な知識を提供します。

## 2. Kubernetes Helm Chart 構成

Cryptomeria のデプロイは `ops/infra/k8s/helm/cryptomeria` にある Helm Chart で管理されています。

### 2.1 主要ファイルと役割

| ファイル | 役割 |
| :--- | :--- |
| `Chart.yaml` | チャートのメタデータ定義。 |
| `values.yaml` | デフォルト設定値。`chains` リストで FDSC/MDSC/GWC の構成を定義します。 |
| `templates/chain-statefulset.yaml` | **最重要**。ブロックチェーンノード本体（StatefulSet）を定義。`{{- range .Values.chains }}` により複数チェーンを一括生成します。 |
| `templates/service.yaml` | Headless Service（P2P用）と ClusterIP/NodePort（RPC/API用）を定義。 |
| `templates/job-mnemonic-generator.yaml` | `pre-install` フックで実行される Job。全チェーン共通の秘密鍵（Mnemonic）を生成します。 |
| `templates/configmap.yaml` | `entrypoint-chain.sh` などの初期化スクリプトを Pod に注入します。 |
| `templates/rbac.yaml` | Job や Pod が Kubernetes API（Secret等）を操作するための権限設定。 |

## 3. デプロイフロー詳細（`just all-in-one` の裏側）

`just all-in-one` コマンドを実行した際の、システム内部の挙動を時系列で解説します。

### Phase 1: ホスト側（Just & Shell）

1.  **環境クリーンアップ (`clean-k8s`)**
    *   既存の Helm Release、PVC、Namespace を削除し、更地に戻します。
2.  **ビルド (`build-all`)**
    *   `ignite chain build` で各チェーンのバイナリ（`gwcd`, `mdscd`, `fdscd`）をコンパイル。
    *   `docker build` でコンテナイメージを作成。
3.  **Values 動的生成**
    *   引数（例: `chains=2`）に基づき、`generate-values.sh` が一時的な `values.yaml` を生成します。
4.  **Helm Install**
    *   生成された設定で Kubernetes にデプロイを要求します。

### Phase 2: Kubernetes クラスタ内

Helm Install がトリガーとなり、以下の順序でリソースが起動します。

#### 1. 共通鍵生成 (`job-mnemonic-generator`)
*   **タイミング:** メインの Pod が起動する**前**（Helm Hook: `pre-install`）。
*   **動作:** Node.js スクリプトが実行され、HD Wallet の Mnemonic を生成。
*   **結果:** 生成した Mnemonic を Kubernetes Secret（`cryptomeria-mnemonics`）として保存。これが全チェーンで共有されます。

#### 2. チェーンノード初期化 (`entrypoint-chain.sh`)
*   **タイミング:** StatefulSet の Pod 起動時（`gwc-0`, `fdsc-0` 等）。
*   **動作:**
    1.  **鍵のインポート:** Secret から Mnemonic を読み込み、`validator`, `relayer`, `localAdmin` の鍵を復元。
        *   HD Path は CosmJS と互換性を持たせるため明示的に指定（例: Validator=`.../0`, Relayer=`.../1`）。
    2.  **Genesis 生成:** `genesis-server` から `genesis.json` と `priv_validator_key.json` をダウンロード。
    3.  **起動:** プロセスを開始（開発モードならホットリロード）。

#### 3. IBC リレーイヤー & 接続 (`init-relayer.sh`)
*   **タイミング:** Relayer Pod 起動時。
*   **動作:**
    1.  **待機:** 各チェーンのブロック生成（Height >= 5）を待つ。
    2.  **接続:** `rly transact link` を並列実行し、IBC チャネルを確立。
    3.  **Storage 登録:** **ここが重要**。Relayer コンテナ内から `gwcd tx gateway register-storage` を発行し、GWC に MDSC/FDSC のエンドポイントを登録する。
    4.  **開始:** `rly start` でパケット中継開始。

## 4. クリティカルな実装ポイント

開発やトラブルシュート時に知っておくべき仕様です。

### 4.1 StatefulSet の採用理由
*   **不変の ID:** `fdsc-node-0` のように名前が固定されるため、P2P の `persistent_peers` 設定が安定します。
*   **永続化:** Pod が再起動しても PVC（ディスク）は維持され、ブロックデータは失われません。

### 4.2 Genesis Server パターン
*   複数ノード構成（FDSCのスケール等）では、全ノードが **「全く同じ genesis.json」** を持って開始する必要があります。
*   本システムでは `genesis-server`（nginx）を立て、最初のノードが作った genesis.json を配布・共有する方式（または共有ボリューム方式など、構成による）を採用し、整合性を保っています。

### 4.3 秘密鍵の共有 (Development Mode)
*   開発の利便性のため、**全ノード・全コンポーネントが同じ Mnemonic (Admin権限) を共有** しています。
*   これにより、どの Pod に入っても `gwcd tx ...` 等の管理者操作が可能です。
*   **注意:** 本番環境ではこの「鍵共有」と「staticMnemonics」は無効化し、厳格な鍵管理（External Secrets Operator等）に移行する必要があります。

## 5. 関連ファイル
*   デプロイ操作ガイド: `05_デプロイ・運用ガイド.md`
*   StatefulSet テンプレート: `ops/infra/k8s/helm/cryptomeria/templates/chain-statefulset.yaml`
*   NodePort 設定: `ops/infra/k8s/helm/cryptomeria/values.yaml`
