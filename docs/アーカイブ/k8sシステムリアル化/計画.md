# Cryptomeriaメインシステム "リアル化" 計画書

## 1. 計画の目的
本計画は、Kubernetes上で稼働するモジュラーブロックチェーンシステム「Cryptomeria」の構成を、開発用の簡易構成から、実際のメインネット運用に即した分散構成へと移行させることを目的とする。
具体的には、以下のギャップを解消する：

1. **初期化の自律性:** 「各ノードが勝手に自分だけのブロックチェーンを開始する」状態から、「既存のネットワーク（Genesis）に参加する」状態へ移行する。
2. **ネットワークの識別:** FDSC（ストレージチェーン）群を単なるコピーではなく、それぞれが固有のChain IDと署名を持つ独立したブロックチェーンとして確立する。
3. **接続の永続性:** Kubernetesの内部DNSに依存せず、固定ポート（Static IPの模倣）を用いた接続環境を構築し、外部ツール（CLI、Relayer）からの安定したアクセスを保証する。

## 2. 詳細仕様と修正項目
### A. Genesis Server（「神」の役割）の導入

全チェーンの「正本」となる `genesis.json` を一元管理・生成・配布する専用サーバーを構築する。

* **役割:** 世界の創造（Genesis生成）と配布。
* **構成:** 軽量なWebサーバー（Nginx等）と初期化スクリプトを含むPod。
* **生成ロジック:**
* **GWC / MDSC:** 単一の `genesis.json` を生成。
* **FDSC:** `replicas` の数だけループし、**それぞれ異なる `chain_id`（fdsc-0, fdsc-1...）** で `init` および `gentx`（バリデータ署名）を実行する。
* **重要:** 単なるファイルコピーではなく、各チェーンIDに対して正しい署名を持つ `gentx` を生成すること。

### B. ノード起動プロセス（Entrypoint）の改修

各チェーンノード（GWC, MDSC, FDSC）の `entrypoint-chain.sh` を、「創造主」から「参加者」の振る舞いに変更する。

* **廃止:** `gwc init`, `gentx` などの自己生成コマンド。
* **新設:**
* 起動時に `http://genesis-server/<chain-id>.json` へアクセスし、Genesisファイルを取得する処理。
* データディレクトリ（`~/.gwc/data`）が既に存在する場合は、取得をスキップしてプロセスを開始する（永続化対応）。

### C. 外部アクセスとポート固定（Static IPシミュレーション）

Kubernetesの `NodePort` を活用し、各チェーンがホストマシン（localhost）に対して固定のポートを持つように構成する。

* **ポート設計:**
* **GWC:** RPC=`30007` (Base `30000`)
* **MDSC:** RPC=`30017` (Base `30010`)
* **FDSC:** RPC=`30027` + (`index` * 10)
* 例: FDSC-0 = `30027`, FDSC-1 = `30037`...

* **Helm実装:** `service.yaml` にてGo Template演算を用い、レプリカのインデックスに基づいてポート番号を自動算出・固定する。

## 3. 修正フロー以下の順序で実装および適用を行う。

1. **Infrastructure Layer (Helm/K8s)**
* `genesis-server` 用のDeployment/Serviceテンプレート作成。
* FDSC用 `Service` 定義の修正（NodePortの計算式導入）。
* `values.yaml` へのポート設定・Genesisサーバー設定の追加。


2. **Logic Layer (Scripting)**
* Genesis Server用の生成スクリプト作成（Chain IDごとのループ処理実装）。
* 各チェーンの `entrypoint-chain.sh` の書き換え（`curl` ロジックへの変更）。


3. **Operation Layer (Command)**
* `justfile` へのクリーンアップコマンド（PVC削除含む）の追加。

## 4. 最終的な到達状態システム

デプロイ後、以下の状態が実現されていること。

1. **分離された起源:** ノードのPod内では `genesis.json` が生成されず、外部からダウンロードされたものが配置されている。
2. **独立した多重宇宙:** FDSC-0 と FDSC-1 が、バイナリは同じだが `Chain ID` が異なる別々のブロックチェーンとして稼働している。
3. **永続性:** Podを再起動（delete/apply）しても、ブロック高（Height）が `0` に戻らず、前回の続きからブロック生成が再開される。
4. **外部操作性:** ホストマシンのターミナルから、ポート番号を変えるだけで任意のチェーン・任意のシャードにCLIコマンドを送信できる。

## 5. 達成要件（Acceptance Criteria）| 項目 | 要件詳細 |
| --- | --- |
| **Genesis分離** | 各ノードの起動ログに `Init` や `Gentx` の実行ログがなく、`Downloading genesis...` のようなログが存在すること。 |
| **FDSC同一性** | `fdsc-0` と `fdsc-1` で `genesis.json` の中身（特に `chain_id` と `app_state.genutil.gen_txs`）が異なっていること。 |
| **ポート固定** | 何度デプロイし直しても、FDSC-0 の RPCポートは常に `30027`（設定値）であり、ランダムなポートに変わらないこと。 |
| **データ永続化** | `helm uninstall` -> `helm install` の流れ（PVC維持）で、ブロック高がリセットされないこと。逆に `just clean-all` でリセットされること。 |

## 6. 検証方法実装完了後、以下の手順で検証を行う。

### STEP 1: Genesis配信の確認

```bash
# Genesis Serverへの疎通とChain IDごとのファイル差異確認
curl http://localhost:<GenesisPort>/fdsc-0.json | grep "chain_id"
curl http://localhost:<GenesisPort>/fdsc-1.json | grep "chain_id"
# -> それぞれ "fdsc-0", "fdsc-1" と出力されること

```

### STEP 2: ノード接続確認 (Localhost)
```bash
# GWCへのアクセス
gwcd status --node tcp://localhost:30007 | jq .NodeInfo.network
# -> "gwc"

# FDSC-0へのアクセス
fdscd status --node tcp://localhost:30027 | jq .NodeInfo.network
# -> "fdsc-0"

# FDSC-1へのアクセス
fdscd status --node tcp://localhost:30037 | jq .NodeInfo.network
# -> "fdsc-1"

```

### STEP 3: 永続化テスト1. 現在のブロック高を確認: `fdscd status ...` (例: Height 50)
2. Podを削除: `kubectl delete pod -l app=fdsc,index=0`
3. Pod再起動後、再度ステータス確認。
4. Heightが `1` ではなく `51` 以降になっていれば成功。

---

この仕様に基づき、TDD（テスト駆動開発）または実装フェーズへ移行します。