# 要件定義書 v3.4 - モジュラー型インターチェーンWEBホスティング

> **v3.3 からの主な変更点（要旨）**
> - **GWC Sidecarを廃止**: クライアントからGWCへの直接Tx投入（Zip Upload）に一本化
> - **Upload整合性の保証**: 「全FragmentのIBC Ack受信後にManifestを公開」する**Atomic Upload**を実装要件化
> - **Service Discovery**: Read時の参照先（MDSC/FDSC）をオンチェーン情報から**動的解決**する方式へ変更
> - **Readインターフェース**: GWCの提供するエンドポイントを `/render` (Query Parameter) ベースに修正

---

## 1. はじめに

### 1.1. 背景・目的

#### 1.1.1. 目的
本システムは、Cosmosエコシステムのモジュラー性を活用し、WEBリソースをブロックチェーン上に永続的に保存・配信する「オンチェーンWEB」システムのPoCを行うことにある。
従来のモノリシックなブロックチェーンストレージとは異なり、**「受付(Execution)」「管理(Metadata)」「保存(Storage)」**の役割を異なるチェーンに分離し、スケーラビリティとデータの永続性を両立させる。

#### 1.1.2. 背景
DAppsの普及に伴い、フロントエンドの永続性欠如（サーバーダウンやリンク切れ）が課題となっている。既存のオンチェーンストレージはコストや速度の面でWebホスティングには不向きであり、Internet Computerのような巨大な独自エコシステムは移植性に欠ける。
そこで本システムでは、Cosmos SDKとIBCを用いた「インターチェーン分散ファイルシステム」を構築し、軽量かつ汎用的なWebホスティング基盤を提案する。

---

## 2. システム概要

本システムは、3層のブロックチェーン群によって構成される分散ストレージネットワークである。
クライアント（ブラウザ）はGWCのレンダリングAPIにアクセスすることで、分散保存されたデータをブラウザ互換のHTTPレスポンスとして受け取る。

### 2.1. アーキテクチャコンセプト

- **GWC (Gateway Chain) / Router**
    - **Execution**: Uploadトランザクション（Zip/File）の受付、解凍、分割（Sharding）、IBC配送
    - **Session Manager**: アップロードの整合性管理（全Ack待機後の公開）
    - **Read Interface**: MDSC/FDSCを動的に参照・復元し、HTTPで配信する
    - **stateは保持**し、**ブロック履歴・過去状態は短期保持**とする

- **MDSC (ManifestData Storage Chain) / Index**
    - Projectの構成（Manifest）とバージョン管理
    - 公開の確定点（公開時点は MDSC の確定ブロックで定義）

- **FDSC (FragmentData Storage Chain) / Body**
    - MB級の断片データ（Fragment/Part）を保存（KV）
    - Project構造は知らない（Key-Valueのみ）
    - **書き込みはGWCからのIBCチャネル経由のみ許可**

### 2.2. 用語定義

- **GWC (Gateway Chain)**：Upload受付、分割、IBC配送、HTTP配信（Read）を担うチェーン
- **MDSC (ManifestData Storage Chain)**：ManifestとVersionを永続管理するチェーン
- **FDSC (FragmentData Storage Chain)**：断片データ（MB級）をKVで永続管理するチェーン
- **IBC (Inter-Blockchain Communication)**：チェーン間のパケット転送プロトコル
- **Project / Asset / EntryPoint**
    - ProjectNameをURLネームスペースとし、配信対象のファイル集合（フォルダ）を管理単位とする
    - EntryPointはMVPとして `index.html` を標準とする

---

## 3. 基本要件

### 3.1. 利害関係者
- **デプロイヤー（ホスト）**：コンテンツをアップロードするユーザー
- **ビューワー（クライアント）**：Webページを閲覧するユーザー（ブラウザ）
- **デベロッパー（運用者）**：システム運用者（relayer運用含む）

### 3.2. スコープ

- **Scope In**
    - Upload：Zipファイル等をTxとして投入し、GWC内で分割・分散保存する
    - Read：HTTPリクエストに対し、復元したリソースをHTTPレスポンスとして返す
    - Project単位でのバージョニング管理（Semantic Versioning）
    - 整合性保証（Atomic Upload）：全データの保存が確認された場合のみ公開する

- **Scope Out**
    - GWC Sidecarによるオフチェーン分割（GWC内部処理へ移行）
    - 物理削除（論理削除/バージョン切替のみ）
    - サーバーサイド動的実行

---

## 4. 機能要件

## 4.1. コンポーネント詳細

### 4.1.1. GWC (Gateway Chain)

#### 役割
- Upload：Tx受付、Zip解凍、分割、IBC配送（FDSC/MDSCへ）、Ack監視
- Read：MDSC/FDSC動的参照、復元、HTTP配信

#### Upload（受付と整合性）
- クライアントは **Zip化されたプロジェクトを `MsgUpload` トランザクションとしてGWCへ送信**する。
- GWCは受信データをメモリ上で解凍・分割し、各FDSCへIBCパケットで並列送信する。
- **Atomic Publication**: GWCはFDSCからの**IBC Acknowledgement（保存成功通知）を監視**する。全てのFragmentの保存が確認された後にのみ、MDSCへManifest登録パケットを送信する。一部でも失敗した場合は公開しない。

#### Read（HTTP配信）
- GWCは `/render` エンドポイントを提供する。
- オンチェーンに登録された `StorageInfo` に基づき、接続すべきMDSC/FDSCのAPIエンドポイントを**動的に解決**する。

---

### 4.1.2. （欠番：GWC Sidecar廃止）
*(v3.3までのSidecar機能はGWC Keeper内部ロジックへ統合されました)*

---

### 4.1.3. MDSC (ManifestData Storage Chain)

#### 役割
- Project単位のManifest保存
- Versioning（最新版解決、SemVer）

#### 公開時点の定義
- **公開時点 = MDSCにて対象VersionのManifestが確定したブロック高/時刻**
- GWCによるAck確認後に送信されるため、MDSCにManifestが存在することは「実データがFDSCに揃っている」ことを意味する。

---

### 4.1.4. FDSC (FragmentData Storage Chain)

#### 役割
- 断片（MB級）をKVに保存するBlobストレージ

#### 書き込み制約
- **FDSCへの書き込み（断片保存Tx）は、GWCとのIBCチャネル経由のみ許可する**

#### 冪等性ルール
FDSCは `part_id` をキーとし、以下のルールで受理する：
- **同じIDが無い**：保存（Tx処理）
- **同じIDで内容が同じ**：スルー（成功扱い）
- **同じIDで内容が違う**：拒否（Conflict）

---

## 4.2. データ処理フロー

### 4.2.1. アップロードフロー（Write）

#### 概要
- クライアントがGWCへ直接 `MsgUpload` (Zip含む) を送信
- GWCが解凍・分割し、FDSCへ並列送信（IBC）
- GWCが**全FragmentのAck受信**を待機（Staging状態）
- 全Ack受信後、GWCが自動的にMDSCへManifestを送信（IBC）
- MDSCでの保存をもって「公開」完了

| ステップ | 担当 | アクション | 備考 |
|---|---|---|---|
| 1 | Client → GWC | `MsgUpload` 送信 | Zipデータを含むTx |
| 2 | GWC | 解凍・分割・UploadID生成 | メモリ上で処理 |
| 3 | GWC → FDSC | IBCで断片保存パケット送信 | Packet送信 |
| 4 | GWC | **Wait for ACKs** | 全FragmentのAckを待機 |
| 5 | GWC → MDSC | IBCでManifest登録 | **全Ack成功時のみ実行** |
| 6 | MDSC | Manifest確定 | 公開完了 |

---

### 4.2.2. ダウンロード・閲覧フロー（Read）

#### 概要
- ブラウザはGWCのレンダリングAPIへアクセス
- GWCは `StorageInfo` からMDSC/FDSCの場所を特定
- Manifestと断片を取得・復元して返却

| ステップ | 担当 | アクション | API例 |
|---|---|---|---|
| 1 | Browser → GWC | HTTP GET リクエスト | `/render?project=...&path=...` |
| 2 | GWC | StorageInfoからMDSC検索 | (Internal) |
| 3 | GWC → MDSC | Manifest取得 | `/mdsc/.../manifest/{project}` |
| 4 | GWC → FDSC群 | 断片を取得（並列） | `/fdsc/.../fragment/{id}` |
| 5 | GWC | 断片を結合し復元 | - |
| 6 | GWC → Browser | HTTPレスポンス | Content-Type付与 |

---

## 4.3. データ構造要件

### 4.3.1. Manifest（MDSC保存）
- 変更なし（v3.3準拠）
- `files[path]`、`mime_type` 等を保持

### 4.3.2. Part/Fragment（FDSC保存）
- 変更なし（v3.3準拠）
- `part_id` によるKVS

---

## 4.4. 更新（Update）要件
- 変更なし

---

## 4.5. 認可・署名

- PoCでは手数料（Gas）は考慮しない（0 Gas）。
- Authzによる代理署名等の運用は引き続き検討範囲とするが、基本はクライアント署名によるTx投入とする。

---

## 5. 非機能要件

### 5.1. 可用性・拡張性
- **動的トポロジー解決 (Service Discovery)**
    - GWCは接続先のMDSC/FDSCエンドポイントをコードにハードコードせず、オンチェーンの `StorageInfo` から動的に解決する。
    - これにより、ノードのIP変更や構成変更に対し、GWCの再起動やリビルドなしで追従可能とする。

### 5.2. 運用・保守
- **GWCの状態保持**
    - アップロードセッション情報（Ack待ち状況）は、処理完了まで保持する。
    - 完了したセッション情報は速やかに破棄（Prune）する。

### 5.3. 性能
- **MB級フラグメント**
    - IBCパケットオーバーヘッド削減のため、断片サイズは数MB（デフォルト1MB〜）を推奨とする。

---

## 6. Web互換性（MVP要件）

### 6.1 ルーティングインターフェース
実装上のエントリポイントは以下の通りとする。
- **Endpoint**: `/render`
- **Query Params**:
    - `project` (必須): プロジェクト名
    - `path` (任意): ファイルパス（デフォルト `index.html`）
    - `version` (任意): バージョン（省略時は最新）

### 6.2 Content-Type / バイナリ
- Manifestの `mime_type` に従い、バイナリとして適切に返却する。

### 6.3 HTTPエラー
- **StorageInfo未登録**: 503 Service Unavailable
- **MDSC/FDSC接続不可**: 502 Bad Gateway
- **Manifest/Fileなし**: 404 Not Found

---

## 7. 制約条件

- Cosmos SDK / IBC準拠
- 言語: Go (Core Logic), TypeScript (Tooling)
- **Zip解凍制限**: GWCでの解凍時、Zip Bomb等の攻撃を防ぐため、展開サイズ上限（例: 100MB）を設ける。

---

## 8. 識別子仕様

- **upload_id**: `ProjectName` + `Timestamp` 等で生成し、Ack待機セッションのキーとして使用する。
- **part_id**: 冪等性を担保するため決定的IDを使用する。