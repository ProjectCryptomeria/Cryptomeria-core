# Gateway–Message 構成における  
## IBCを用いたオンチェーンデータ保存・配信設計の検討整理

---

## 0. この資料の目的

本資料は、Cosmos SDK / IBC を前提とした **複数チェーン構成**において、

- データを **確実にブロックチェーン上に保存**しつつ
- **高頻度なダウンロード要求**に耐え
- **ストレージ肥大・単一ノード集中・ノード一覧管理**といった問題を回避する

ための設計検討を整理したものである。

単なる実装案ではなく、  
**「ブロックチェーンらしさとは何か」という思想的前提**も含めて記述する。

---

## 1. 前提と基本構成

### 1.1 想定技術
- Cosmos SDK
- Tendermint（CometBFT）
- IBC（Inter-Blockchain Communication）
- オンチェーン state + オフチェーン通信の併用

---

### 1.2 登場主体（用語定義）

#### クライアント（Client / c）
- システム利用者
- メッセージの保存・取得を行いたい
- **直接 Message チェーンにはアクセスしない**

---

#### Gateway チェーン（g）
- クライアントとの **唯一の窓口**
- upload / download の入口
- Message チェーンと IBC 接続を持つ
- データの長期保存は目的ではない

---

#### Message チェーン（m）
- **データ保存専用チェーン**
- メッセージデータ（msgd）をオンチェーン state に保存する
- 保存されたデータは原則として永続

---

#### Relayer（r）
- g と m を監視する非ブロックチェーンプロセス
- IBC パケットの中継
- 場合によってはデータ取得の補助も行う
- **理論上は1つでも動作可能であることが原則**

---

#### メッセージデータ（msgd）
- 保存したい実データ本体
- 任意サイズを想定

#### メッセージID（msgid）
- msgd に対応する識別子
- ダウンロード時のキー

---

## 2. 最終的に実現したいこと（ゴール）

### 2.1 機能的ゴール

- **msgd をブロックチェーン上に保存する**
  - 特に Message チェーンを保存主体とする
- **クライアントは Gateway チェーンだけを使う**
- **ダウンロードは高頻度でも破綻しない**
  - 秒間数百回、累計数十万回を想定
- **受信途中での改ざんを検出できる**

---

### 2.2 思想的ゴール（重要）

- チェーン同士やノード同士が  
  **「相手の全ノードIPを知っている」前提を置かない**
- DNSのような「一覧管理」ではなく、  
  **P2P的にツテを辿る性質**を尊重する
- 「ノード集合」を台帳に固定しない
- ブロックチェーンを **普通のAPIサーバ群にしない**

---

## 3. 発生した問題（段階的）

---

### 問題1：Gateway チェーンが肥大化する

#### 状況
- c → g に msgd を含むトランザクションを送信
- g は IBC により m に転送

#### 問題
- msgd は **g のブロックヒストリーにも含まれる**
- 結果として g も「保存チェーン」になってしまう
- g ノードのストレージ圧迫

---

### 問題2：ダウンロードのたびに Message チェーンが肥大化する

#### 状況
- tx_down を IBC で m に送り
- m が msgd を IBC で返す

#### 問題
- ダウンロード回数分だけ msgd が履歴に再登場
- **ダウンロード回数 ∝ ヒストリー増大**
- 保存チェーンとして致命的

---

### 問題3：HTTP ダウンロードにすると単一ノード集中

#### 状況
- ダウンロードを IBC ではなく HTTP に変更

#### 問題
- 特定の m_node にアクセスが集中
- 単一障害点
- 分散性喪失

---

## 4. 問題への逐次的な解決策（検討の流れ）

---

### 解決策A：Gateway を Prune ノード運用

- g の全ノードを prune 運用
- ストレージ圧迫は緩和

**限界**
- 一度は msgd を受信・検証している
- 「知らないまま正当性だけ確認」にはならない

---

### 解決策B：ダウンロードは HTTP にする

- msgd 増殖問題は回避

**新たな問題**
- 単一ノード集中
- ノード間通信化

---

### 解決策C：IBC では msgd ではなく「制御情報」を送る

#### 発想
- IBC で送るのは **小さな情報のみ**
- msgd 本体は HTTP で取得

#### 成果
- msgd の増殖は防げる
- IBC の「チェーン間通信」性質を部分的に保持

---

## 5. 解決策Cから派生した未解決問題

1. Relayer が1つしかない場合、結局集中する
2. 全 m_node の IP リスト送信は履歴を圧迫
3. そもそも m が全ノード IP を知るのは不自然
4. 一部ノード選出の基準が難しい
5. 事前 IP 配布は更新・存在保証が困難

---

## 6. 現在の到達点：設計として見えてきたこと

### 6.1 重要な認識

- **オンチェーンで「読む」ことはスケールしない**
- 極小データでも、要求回数に比例して履歴は増える
- ダウンロードは **オンチェーンに刻まない**必要がある

---

### 6.2 有効と判断された方向性

- **upload**
  - IBC で m にオンチェーン保存
- **download**
  - オフチェーン取得
  - proof による改ざん検証
  - 窓口は g のみ

---

## 7. 守りたい原則（確定）

### 技術的原則

1. msgd は必ず Message チェーン上に存在する
2. ダウンロードでチェーンヒストリーを増やさない
3. 改ざんは検出可能である
4. クライアントの入口は Gateway チェーンのみ
5. m 側の特定ノードに処理が集中しない構造を目指す
6. relayer は **1つでも動作可能**

---

### 思想的原則

7. チェーンは相手チェーンの全ノードを知らなくてよい
8. ノード一覧を台帳に固定しない
9. DNS的な完全リスト管理を前提にしない
10. P2P 的な「ツテを辿る」性質を尊重する
11. ブロックチェーンを単なるサーバ群にしない

---

## 8. 現在の未解決テーマ

- **relayer が1つでも動く**
- **ノード一覧を固定しない**
- **それでも m 側の集中を抑制する**

この3条件をどこまで同時に満たせるか。

→ 現状では  
**「保証」は不可能だが、「集中しにくい構造」は作れる**  
という地点まで到達している。

---

## 9. 次の検討フェーズ（予告）

- relayer を P2P クライアントとして扱う設計
- proof 検証を前提とした取得競合モデル
- 「集中を抑制する」ことを仕様としてどこまで明文化するか

---