# 要件定義書 v3.3 - モジュラー型インターチェーンWEBホスティング（改訂）

> v3.2 からの主な変更点（要旨）
> - Read経路を **HTTP→GWC→(MDSC/FDSC参照)→HTTPレスポンス** に統一（ブラウザ直問い合わせを廃止）
> - Uploadは **HTTPでGWCサイドカーへ投入 → サイドカーが分割Tx化 → GWC → IBCでFDSC/MDSC** に整理
> - **公開は「全FragmentのFDSC確定（IBC Ack受領）後にManifestをMDSCへ送信」**とし、公開整合を保証
> - GWCは **state保持 / ブロック履歴・過去状態は短期保持**（保持期間は **Relayer最大停止時間×安全率**で設計）
> - フラグメントサイズは **MB級（例：1〜10MB）** を前提にし、断片爆発を回避
> - 再送・重複排除は **決定的ID（冪等キー）** と **Conflict拒否**（同IDで内容が違えば拒否）で簡素化
> - 公開時点は **MDSCでManifestが確定したブロック高/時刻** に固定（Manifest内timestampは参照用）
> - WebホスティングのMVP要件（index/Content-Type/404/バイナリ返却）を明文化
> - Version指定を `?version=` として明文化（省略時は最新版）
> - ProjectName（URLパス）に関する制約を明文化（`.` を許可）
> - PoCにおける課金方針（gasPrice=0）と authz による代理署名方針を明文化

---

## 1. はじめに

### 1.1. 背景・目的

#### 1.1.1. 目的
本システムは、Cosmosエコシステムのモジュラー性を活用し、WEBリソースをブロックチェーン上に永続的に保存・配信する「オンチェーンWEB」システムのPoCを行うことにある。  
従来のモノリシックなブロックチェーンストレージとは異なり、**「受付(Execution)」「管理(Metadata)」「保存(Storage)」**の役割を異なるチェーンに分離し、スケーラビリティとデータの永続性を両立させる。

#### 1.1.2. 背景
DAppsの普及に伴い、フロントエンドの永続性欠如（サーバーダウンやリンク切れ）が課題となっている。既存のオンチェーンストレージはコストや速度の面でWebホスティングには不向きであり、Internet Computerのような巨大な独自エコシステムは移植性に欠ける。  
そこで本システムでは、Cosmos SDKとIBCを用いた「インターチェーン分散ファイルシステム」を構築し、軽量かつ汎用的なWebホスティング基盤を提案する。

---

## 2. システム概要

本システムは、3層のブロックチェーン群によって構成される分散ストレージネットワークである。  
クライアント（ブラウザ）は `http://cryptomeria.com/<ProjectName>/<path>` にアクセスするだけで、GWCが必要なデータを収集しブラウザ互換のHTTPレスポンスを返す。

### 2.1. アーキテクチャコンセプト

- **GWC (Gateway Chain) / Router**
  - Upload受付、分割Tx生成の起点（サイドカーと連携）、IBC配送
  - Read時は MDSC/FDSC を参照して復元し、HTTPで配信する
  - **stateは保持**し、**ブロック履歴・過去状態は短期保持**とする（5.2参照）

- **MDSC (ManifestData Storage Chain) / Index**
  - Projectの構成（Manifest）とバージョン管理
  - 公開の確定点（公開時点は MDSC の確定ブロックで定義）

- **FDSC (FragmentData Storage Chain) / Body**
  - MB級の断片データ（Fragment/Part）を保存（KV）
  - Project構造は知らない
  - **書き込みはGWCからのIBCチャネル経由のみ許可**（4.1.4参照）

### 2.2. 用語定義

- **GWC (Gateway Chain)**：Upload受付、分割、IBC配送、HTTP配信（Read）を担うチェーン
- **GWC Sidecar**：GWC近傍で動作するコンポーネント。大容量フォルダをHTTPで受け取り、分割Txを生成してGWCへ送信する
- **MDSC (ManifestData Storage Chain)**：ManifestとVersionを永続管理するチェーン
- **FDSC (FragmentData Storage Chain)**：断片データ（MB級）をKVで永続管理するチェーン
- **IBC (Inter-Blockchain Communication)**：チェーン間のパケット転送プロトコル
- **Project / Asset / EntryPoint**
  - ProjectNameをURLネームスペースとし、配信対象のファイル集合（フォルダ）を管理単位とする  
  - EntryPointはMVPとして `index.html` を標準とする

---

## 3. 基本要件

### 3.1. 利害関係者
- **デプロイヤー（ホスト）**：コンテンツをアップロードするユーザー
- **ビューワー（クライアント）**：Webページを閲覧するユーザー（ブラウザ）
- **デベロッパー（運用者）**：システム運用者（relayer運用含む）

### 3.2. スコープ

- **Scope In**
  - Upload：フォルダ（プロジェクト）を投入し、分割・分散保存する
  - Read：HTTPリクエストに対し、復元したリソースをHTTPレスポンスとして返す
  - Project単位でのバージョニング管理（Semantic Versioning）
  - VersionのHTTP指定（`?version=`）および省略時最新版解決

- **Scope Out**
  - 物理削除（論理削除/バージョン切替のみ）
  - サーバーサイド動的実行
  - 高度なCDN/Anycast等のロードバランシング設計（PoCでは別途検討）

---

## 4. 機能要件

## 4.1. コンポーネント詳細

### 4.1.1. GWC (Gateway Chain)

#### 役割
- Upload：受付、分割、IBC配送（FDSC/MDSCへ）
- Read：MDSC/FDSC参照、復元、HTTP配信

#### Upload（受付）
- クライアントは **フォルダ（プロジェクト）をHTTPでGWC Sidecarへ送信**する（大容量対応）
- Sidecarは受領したフォルダをスナップショット化し、内部で分割処理を行う
- **GWCはFDSCへの保存について、全Fragmentの確定（IBC Ack受領）を確認した後にのみ、MDSCへManifest登録Txを送信する**（公開整合）

#### Read（HTTP配信）
- ブラウザのHTTPリクエストを受け取り、MDSCからManifestを取得
- Manifestの指示に基づき、FDSCから断片を取得し復元してHTTPレスポンスとして返す

---

### 4.1.2. GWC Sidecar

#### 役割
- 大容量フォルダの受領（HTTP）
- フォルダのスナップショット化（アップロード中に内容が変わらないように固定）
- MB級断片への分割
- 分割Txの生成と送信（GWCへ）
- MIME type 推定（拡張子マッピング等）とManifestへの埋め込み（2-7）

#### 分割サイズ
- 断片（Part/Fragment）サイズは **MB級（例：1〜10MB）** を標準とする  
  ※旧1KB〜10KBは断片数が爆発するため採用しない  
- 1MB未満のファイルは原則1パート（分割しない）

---

### 4.1.3. MDSC (ManifestData Storage Chain)

#### 役割
- Project単位のManifest保存
- Versioning（最新版解決、SemVer）
- 公開確定点の提供

#### 公開時点の定義
- **公開時点 = MDSCにて対象VersionのManifestが確定したブロック高/時刻**
- Manifest内timestampは参照用とし、監査根拠はMDSC確定ブロックを優先する

#### 最新版解決
- `?version=` が省略された場合、MDSCのVersion解決ロジックにより「最新版」を決定する

---

### 4.1.4. FDSC (FragmentData Storage Chain)

#### 役割
- 断片（MB級）をKVに保存するBlobストレージ
- Project構造は保持しない

#### 書き込み制約
- **FDSCへの書き込み（断片保存Tx）は、GWCとのIBCチャネル経由のみ許可する**
- Read用途として、GWCが取得するためのHTTP/Queryインターフェースは許可する（認可方式はPoC範囲で簡易）

#### 冪等性ルール
FDSCは `part_id` をキーとし、以下のルールで受理する：

- **同じIDが無い**：保存（Tx処理）
- **同じIDで内容が同じ**：スルー（成功扱い）
- **同じIDで内容が違う**：拒否（Conflict）

> Conflict時は「先に確定した内容を正」とする。更新・差替えは新Version/新upload_idで行う。

---

## 4.2. データ処理フロー

### 4.2.1. アップロードフロー（Write）

#### 概要
- クライアントはフォルダをHTTPでSidecarへ送る
- Sidecarが分割Tx化してGWCへ投入
- GWCがIBCでFDSCへ断片を保存し、**全FragmentのFDSC確定（IBC Ack受領）を確認**
- その後GWCがMDSCへManifestを保存
- MDSCのManifest確定により「公開」される（プロジェクトが読み出し可能になる）

#### ステージ（状態）
- **Staging（未公開）**：断片は集まりつつあるが、Manifestが未確定の状態
- **Published（公開済）**：Manifest確定済みで読み出し可能な状態

| ステップ | 担当 | アクション | 備考 |
|---|---|---|---|
| 1 | Client → Sidecar | プロジェクトフォルダをHTTP送信 | 大容量対応 |
| 2 | Sidecar | スナップショット化＆分割（MB級） | 1〜10MB想定 |
| 3 | Sidecar → GWC | 分割Txを送信 | 結果不明時は同IDで再送可能 |
| 4 | GWC → FDSC | IBCで断片保存 | FDSCは冪等ルール適用 |
| 4.5 | GWC | **全パートのIBC Ack受領を確認** | 公開整合条件 |
| 5 | GWC → MDSC | IBCでManifest登録 | Ack確認後に送信 |
| 6 | MDSC | Manifest確定 | 公開時点 |

---

### 4.2.2. ダウンロード・閲覧フロー（Read）

#### 概要
- ブラウザはGWCへHTTPアクセス
- GWCはMDSCからManifest取得（`?version=` 指定可、省略時は最新版）
- Manifestに基づきFDSCから断片を取得し復元
- ブラウザ互換のHTTPレスポンスを返す

| ステップ | 担当 | アクション |
|---|---|---|
| 1 | Browser → GWC | `/<ProjectName>/<path>` をHTTP GET |
| 2 | GWC → MDSC | 対象VersionのManifest取得（省略時は最新版） |
| 3 | GWC → FDSC群 | 断片を取得（必要に応じ並列） |
| 4 | GWC | 断片を結合し復元 |
| 5 | GWC → Browser | `Content-Type`等を付けてHTTPレスポンス |

---

## 4.3. データ構造要件

### 4.3.1. Manifest（MDSC保存）
- Project全体のスナップショット
- `files[path]` に断片リストを保持（復元順序は `part_index` で担保）
- `creator` を保存（所有権/更新権限の根拠）
- `published_at` は参照用（正はMDSC確定ブロック）
- `mime_type` はSidecarが推定し確定値として格納する（配信の同一性確保）

#### 規模上限（PoC）
- 総ファイル数：**最大500**
- 総サイズ：**最大20MB**
- 最大パート数（総数）：**最大600**（上限運用値）

```json
{
  "project_name": "inter.net",
  "version": "1.0.0",
  "creator": "cosmos1...",
  "published_at": "2026-01-14T00:00:00Z",
  "files": {
    "index.html": {
      "mime_type": "text/html",
      "size": 12345,
      "parts": [
        { "part_index": 0, "fdsc_id": "chain-1", "part_id": "u123:index.html:0" },
        { "part_index": 1, "fdsc_id": "chain-2", "part_id": "u123:index.html:1" }
      ]
    }
  }
}
```

### 4.3.2. Part/Fragment（FDSC保存）
- `part_id` は決定的ID（`upload_id + path + part_index` など）
- `value` はバイナリ（base64等）を保持

```json
{
  "key": "u123:index.html:0",
  "value": "base64_encoded_binary_data..."
}
```

---

## 4.4. 更新（Update）要件
- 公開済みVersionのManifestおよび参照断片は**不変**とする
- 変更（ファイル追加/上書き/削除相当）は **Updateトランザクション**により新Versionとして登録する
- 最新版の指す先はMDSCのVersion解決ロジックで決定する

---

## 4.5. 認可・署名（PoC方針）

### 4.5.1. 手数料（PoC）
- PoCでは **gasPrice=0** を前提とし、課金・スパム対策は主目的としない  
  （スパムの危険性は既知リスクとしてPoCで啓蒙対象に含める）

### 4.5.2. 署名と権限委譲
- クライアントはGWCにアカウント登録を行う
- プロジェクトアップロード開始時に、クライアントは **authz によりGWCのシステムアカウントへ必要権限をgrant** する
- 以降のアップロード処理に必要なTxは、**クライアントの委託を受けたGWCシステムアカウントが代理署名**する  
  （クライアント秘密鍵をGWC内に保持しない）

---

## 5. 非機能要件

### 5.1. 可用性・拡張性
- FDSCの追加により保存容量/帯域の拡張を行う
- 大容量UploadはSidecarで分割し、Tx/IBCを分散させる
- Web配信（HTTP）はノードSidecarによる提供を基本とし、特定ベンダー/単一DCへの集中を避ける

### 5.2. 運用・保守

#### GWCの保持方針
- **stateは保持**
- **ブロック履歴・過去状態は短期保持**
- 保持期間は **Relayer最大停止時間×安全率** に基づき設定する  
- **GWCは、IBCのproof生成（packet commitment / acknowledgement等の証明）に必要な過去状態（ブロック/状態バージョン）を、Relayer最大停止時間×安全率の期間保持する。それ以外はPrune可能とする。**

#### Relayer運用（PoC）
- Relayerは運用者が稼働させる
- 停止時の復旧手順と監視（アラート）を運用要件に含める

### 5.3. 性能
- Sidecarの分割・Tx生成・送信をボトルネックとして監視する
- Read時はGWC側で並列取得・復元を行いレイテンシを抑える

---

## 6. Web互換性（MVP要件）

### 6.1 ルーティング
- `/<ProjectName>/` は `index.html` を返す（存在しない場合は404）
- `/<ProjectName>`（末尾スラ無し）は `/<ProjectName>/` と同義として扱う  
  - 実装は「同一扱い」または「末尾スラ付与（301/302）」を採用し、Web業界デファクトに従う
- `/<ProjectName>/<path>` はManifestの `files[path]` を返す

### 6.2 Version指定
- Versionはクエリで指定可能：`/<ProjectName>/<path>?version=1.2.3`
- `version` が省略された場合は最新版を返す

### 6.3 Content-Type / バイナリ
- `Content-Type` はManifestの `mime_type` に従う
- バイナリはそのまま返す（画像/JS/CSS等）
- 未存在は404を返す

### 6.4 HTTPエラー（PoCルール）
- **Manifestがない** → 404
- **全FDSCノードがダウン等で取得不能** → 503
- **データが取得できない / データが壊れている / Manifestはあるがデータが取得できない** → 500

---

## 7. 制約条件

- Cosmos SDKで構築
- IBC準拠
- コアロジックはGo
- 閲覧者は標準ブラウザで完結（専用ウォレット必須等を課さない）
- **ProjectNameはURLパスセグメントとして扱う**（7.1参照）

### 7.1 ProjectName仕様（PoC）
ProjectNameは「URLっぽさ」「読みやすさ」「安全性」を重視し、以下の正規形に制約する。

- 文字種：`a-z` `0-9` `-` `.`
- 先頭・末尾：英数字
- 禁止：`.` 単体 / `..` 単体 / `..` を含む名称（視認性・誤解回避）
- 大文字入力は小文字へ正規化
- 入力は percent-decode 後に検証し、`/` を含む場合は不正

（例：`inter.net` は許可）

---

## 8. 識別子仕様（PoC）

### 8.1 upload_id
- upload_idは「アップロード処理単位で一意」であることを要求する
- 形式（推奨）：`<project_name>-<upload_start_timestamp>-<nonce>`
  - 例：`inter.net-20260114T120102.123Z-a1b2`
- timestampは開始時刻を表し、nonceは同時開始等の衝突回避目的

### 8.2 part_id
- part_idは決定的IDとし、冪等性のキーとする  
- 形式例：`<upload_id>:<path>:<part_index>`
