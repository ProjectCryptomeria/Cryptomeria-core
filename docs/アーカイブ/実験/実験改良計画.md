# 実験用改良計画

## 0. 方針（最優先事項）

* **最優先：卒業研究実験案.md のA〜Fを“確実に回せる”こと**（再現性・失敗率低下・計測のしやすさ）。
* 取り入れる要件定義書（v3-3）要素は、**実装が軽く、バグ防止・安定性に直結するものだけ**に限定。
* 大改造（Sidecar導入／完全なバージョン管理／URLパス方式統一など）は **今回は後回し**。

---

## 1. 改良スコープ

### 今回入れる（軽くて効く v3-3要素 + 実験成立に必須なバグ修正）

1. **/render の復元が確実に動く（バグ修正）**
2. **フラグメントIDを決定的に（冪等性の第一歩）**
3. **FDSC側で「同ID・内容違い」を拒否（Conflict拒否）**
4. **公開整合：全Fragment ACK後にManifest送信（v3-3の肝、ただし最小実装）**
5. **/render の安定化（timeout・リトライ・並列制御）**
6. **最低限の計測ログ（E2E/分解計測ができるログ）**

### 今回は見送る（重い/実験必須でない）

* Sidecar実装（HTTP投入→分割Tx化）
* MDSCの本格バージョン管理（project×version保持、latest解決、`?version=`）
* 分散方式の高度化（ハッシュ分散・バックプレッシャー制御の本実装）
* 課金・authz・権限制御の厳密化

---

## 2. マイルストーン（実験を止めない順）

### M0：実験が“壊れずに動く”状態にする（最短・必須）

**目的**：実験A（復元・ハッシュ比較）が確実に通る土台を作る。

* [ ] **バグ修正①：`uploadFragments` のカウンタ更新**

  * 現状 `*totalChunkIndex++` は危険（Goとして不正/意図通り動かない可能性）。
  * **修正**：`(*totalChunkIndex)++` にする。

* [ ] **バグ修正②：/render がFDSCレスポンスを誤って解釈**

  * 取得JSONは `fragment.data`（base64）なのに `fragment.value` を見ている。
  * **修正**：`fragResp.Fragment.Data` を decode して結合。

* [ ] **/render の HTTP クライアントを Timeout 付きに**

  * `http.Get` 直呼びをやめ、`http.Client{Timeout: ...}` に統一。
  * 失敗時にハングしない（実験の安定性に直結）。

**完了条件（M0）**

* 実験案.md の「実験A(A-2)」相当（全ファイルのsha256比較）が、少なくとも複数回連続で完走する。

---

### M1：冪等性を最低限入れて「再実行に強く」する（v3-3の軽量適用）

**目的**：実験B（再送・失敗条件）や、K8s環境での一時失敗に強くする。

* [ ] **決定的 Fragment ID（v3-3：決定的ID）**

  * 現状：`BlockTime + index` で非決定的 → 再送でIDが変わり、重複排除できない。
  * **最小実装案**

    * `upload_id = sha256(creator + project + version + filename + sha256(zip_bytes))` などをGWC内で生成
    * `fragment_id = fnv64(upload_id + "|" + path + "|" + chunk_index)` のように **uint64へ落とす**（プロトコル変更なし）
  * *注*：64bit衝突は理論上あり得るが、実験用途では十分低確率。将来はstring(sha256hex)へ拡張可。

* [ ] **FDSC：Conflict拒否（v3-3：同IDで内容が違えば拒否）**

  * 受信時に `Fragment.Get(fragment_id)` を確認：

    * 無ければ保存
    * あって `Data` が一致 → 成功扱い（スルー）
    * あって `Data` が不一致 → **エラーACK**（Conflict）
  * これで「再送しても壊れない」「バグでID衝突した時に上書きしない」が成立。

**完了条件（M1）**

* 同一ZIPを同一project/versionで再実行しても、FDSCが壊れず（上書きしない/Conflictで止まる）、結果が再現する。

---

### M2：公開整合（ACK後にManifest送信）を“最小の状態管理”で入れる（v3-3の肝）

**目的**：実験の成功率と説明力を一気に上げる（「Manifestがあるのに断片が揃ってない」状態を潰す）。

* [ ] **GWCにUploadSession（短期状態）を持たせる**

  * 保存するもの（最小）：

    * session_id（= upload_id）
    * project / version
    * filesMap（Manifest相当：mime/size/fragment mapping）
    * pendingFragmentsCount
    * status（staging/published/failed）
  * fragment送信時に pending を増やし、**OnAcknowledgementPacketで減らす**。

* [ ] **ACK受信で pending=0 になった瞬間にManifest送信**

  * `OnAcknowledgementPacket` で受け取る packet data を unmarshal して fragment を識別。
  * すべてACK成功 → `sendManifestPacket()` を実行。
  * ACK error / timeout → session を failed にしてログ（実験で「失敗理由」を回収可能）。

* [ ] **/render は “published” のみ提供**

  * もしMDSCがまだmanifest未登録なら 404 でOK。
  * これにより、実験の「成功/失敗」が明確になる。

**完了条件（M2）**

* 「upload tx成功 → すぐmanifestが見える」ではなく、**全fragment ACK後にのみ manifest が現れる**。
* 実験BのE2E計測がより意味を持つ（整合性を含んだE2Eになる）。

---

### M3：実験計測を楽にし、失敗を減らす（安定性＆観測性）

**目的**：実験B/C/D/E/Fのデータを“集めやすく・比較しやすく”。

* [ ] **/render：並列数制限 + リトライ（軽量）**

  * 現状はfragment数だけgoroutine → FDSC多台数・大量断片で不安定化しやすい。
  * semaphoreで最大並列（例：8〜16）に制限。
  * 一時エラー（502/timeout）に対して短いリトライ（例：2回）を入れる。

* [ ] **ログ計測（最低限）**

  * GWCで以下の区間時間をログ出し（timestamps込みでK8sログから拾える）：

    * Zip展開
    * chunk化
    * fragment送信ループ（件数/総バイト）
    * ACK完了までの時間（M2導入後）
    * manifest送信
  * 実験案.md が求める「内訳」が取りやすくなる。

* [ ] **chunk size のデフォルト見直し（v3-3：MB級）**

  * 実験用デフォルト：1MB（上限10MB）くらいにして断片爆発を回避。
  * CLI `--fragment-size` は引き続き実験で振れる。

**完了条件（M3）**

* 同条件の実験を複数回回しても、/render 失敗が目に見えて減り、ログから遅い箇所を切り分けられる。

---

## 3. 実験A〜Fへの効き方（どれがどの実験を楽にするか）

* **実験A（復元正確性）**：M0（/render修正）＋M1（Conflict拒否）で成功率・再現性が上がる
* **実験B（アップロード性能/ACK議論）**：M2（ACK後公開）＋M3（区間ログ）で“論文向けの説明”が可能に
* **実験C（配信性能）**：M3（timeout/並列制限/リトライ）で測定が安定
* **実験D/E/F（分散・負荷・失敗耐性）**：M1（冪等）＋M2（整合）＋M3（ログ）で比較実験が成立しやすい

---

## 4. 受け入れテスト（最小セット）

* [ ] 同一ZIPで **3回連続**：upload→manifest取得→/render全ファイルsha256一致が通る
* [ ] relayerを一時停止→再開しても、再送や遅延で壊れない（M1/M2の効果確認）
* [ ] 断片数が多い条件でも /render がタイムアウトせず結果が返る（M3）

---

## 5. リスクと回避策（実験優先のための保険）

* **M2（ACK後公開）は実装量が増える**
  → M0/M1で実験が回る状態を確保してから着手。M2はfeature flagでON/OFF可能にして退避路を残す。
* **決定的IDをuint64に落とす衝突リスク**
  → 実験規模なら十分低い。将来はprotoをstring化してsha256hexを使う拡張を“次段”に回す。

---

## 6. 最終成果物（この改良計画で得たい状態）

* 実験を回すたびに「たまに壊れる」「原因が追えない」を無くし、
* **再現性ある計測（E2E＋区間）**と、**整合性の説明（ACK後公開）**ができる状態にする。

