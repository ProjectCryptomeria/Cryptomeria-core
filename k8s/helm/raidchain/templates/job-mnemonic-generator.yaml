apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "raidchain.fullname" . }}-mnemonic-generator
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": "pre-install,pre-upgrade"
    "helm.sh/hook-delete-policy": "before-hook-creation,hook-succeeded"
    "helm.sh/hook-weight": "0"
spec:
  template:
    spec:
      serviceAccountName: {{ include "raidchain.fullname" . }}-sa
      restartPolicy: Never
      containers:
        - name: generator
          image: "node:22-alpine"
          imagePullPolicy: IfNotPresent
          command:
            - /bin/sh
            - -c
            - |
              set -ex

              SECRET_NAME="{{ include "raidchain.fullname" . }}-mnemonics"
              SECRET_FILE="/tmp/secret.yaml"
              
              echo "--- Installing dependencies for mnemonic generation ---"
              # kubectlと@cosmjs/cryptoをインストール
              apk add --no-cache kubectl
              corepack enable
              yarn add @cosmjs/proto-signing

              echo "--- Generating mnemonics via Node.js (@cosmjs/crypto) ---"

              cat <<EOF > ${SECRET_FILE}
              apiVersion: v1
              kind: Secret
              metadata:
                name: ${SECRET_NAME}
                namespace: {{ .Release.Namespace }}
              type: Opaque
              stringData:
              EOF

              {{- range .Values.chains }}
              CHAIN_NAME="{{ .name }}"
              echo "--> Generating mnemonic for ${CHAIN_NAME}..."
              # controllerと全く同じロジックでニーモニックを生成
              MNEMONIC=$(node -e "require('@cosmjs/proto-signing').DirectSecp256k1HdWallet.generate(24).then(wallet => console.log(wallet.mnemonic))")
              
              cat <<EOF >> ${SECRET_FILE}
                ${CHAIN_NAME}.mnemonic: "${MNEMONIC}"
              EOF
              {{- end }}

              echo "--- Applying Secret to the cluster ---"
              kubectl apply -f ${SECRET_FILE}
              echo "--- Secret '${SECRET_NAME}' created/updated successfully ---"
  backoffLimit: 1