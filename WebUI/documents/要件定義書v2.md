# 📜 RaidChain WebUI 詳細仕様書

## 1. はじめに

### 1.1. 概要
本アプリケーションは、分散ストレージシステム「RaidChain」の運用管理、実験実行、および結果分析を行うための統合Webコンソールです。
バックエンド（Controller）の複雑な操作をGUI化し、インフラのデプロイから経済圏の管理、実験シナリオの実行と分析までを一元的に提供します。

### 1.2. 技術スタック
* **Framework**: React 18, Vite
* **Language**: TypeScript
* **Styling**: Tailwind CSS
* **Icons**: Lucide React
* **Charts**: Recharts

---

## 2. 全体共通仕様 (Global Layout & State)

### 2.1. レイアウト構造
画面は「サイドバー（ナビゲーション）」「ヘッダー」「メインコンテンツ」の3領域で構成されます。

* **サイドバー (Navigation)**
    * **メインメニュー**: 以下の6つのレイヤーへの切り替えボタンを配置。アクティブ時は青色の背景とインジケータを表示。
        1.  **Monitoring**: リアルタイム監視
        2.  **Deployment**: インフラ・ノード管理
        3.  **Economy**: アカウント・経済圏管理
        4.  **Scenarios**: 実験シナリオ管理
        5.  **Experiment**: 実験設定・実行
        6.  **Library**: 実験結果アーカイブ
    * **Cluster Info パネル**: サイドバー最下部に固定表示。現在のKubernetesクラスタ情報を表示。
        * Provider: Minikube (固定)
        * K8s Ver: v1.28.3 (固定)
        * Memory: 8192MB (固定)

* **ヘッダー (Header)**
    * **ロゴ**: "RaidChain WebUI" タイトルとバージョン情報 (v2.4.0-rc1)。
    * **システムステータス**: `deployedNodeCount > 0` の場合「System Online (緑/点滅)」、0の場合「System Offline (赤)」を表示。
    * **通知センター (Notifications)**:
        * ベルアイコンをクリックすると通知ドロップダウンを展開。
        * 未読がある場合、赤色のバッジを表示。
        * 通知履歴（成功/エラー/警告）をリスト表示し、「Clear all」で消去可能。

* **トースト通知 (Toast Overlay)**
    * 画面右下に操作結果（成功/失敗）をポップアップ表示。5秒で自動消去。

### 2.2. グローバルステート管理 (App.tsx)
* **インフラ状態**: `deployedNodeCount`（稼働ノード数）, `isDockerBuilt`（ビルド済みフラグ）。
* **経済圏状態**:
    * `users`: ユーザーアカウントのリスト。
    * `systemAccounts`: システムアカウント（Millionaire, Relayer）のリスト。
    * **Relayer同期ロジック**: `deployedNodeCount` が変更されると、ノード数に合わせてRelayerアカウントリストを自動的に再生成・同期する（Millionaireの残高は維持）。
* **実験状態**:
    * `activeExperiment`: 実行中の実験の進捗、ログ、ステータスメッセージを管理。
    * `scenarios`: 保存された実験設定。
    * `results`: 過去の実験結果。

---

## 3. 各画面の詳細仕様

### ① Monitoring Layer (リアルタイム監視)
システム全体の健全性を視覚的に監視します。

* **ネットワークトポロジー図 (Topology Graph)**
    * **可視化**: Control Chain, Meta Chain, Data Chain群の接続関係をSVGで描画。
    * **動的レイアウト**: Data Chainのノード数に応じて描画幅を自動調整。
    * **アニメーション**:
        * ノードの稼働状態に応じたグロー効果（Active: 緑, Inactive: 赤）。
        * パケット転送アニメーション（Control → Data, Control → Meta）。
* **Mempool モニター**
    * **グラフ**: 各Data Chainの未処理トランザクション数を棒グラフ（Recharts）で表示。
    * **アラート**: 滞留数が閾値（150tx）を超えるとバーの色が赤色に変化。
* **ブロック生成モニター**
    * **リスト表示**: 各チェーンのID, Role, Status, Block Height, Tx Count, Latencyを表示。
    * **シミュレーション**: 1秒ごとにブロック高やTx数をランダムに更新し、稼働感を演出。

### ② Deployment Layer (インフラ管理)
DockerイメージのビルドとKubernetesへのデプロイ操作を提供します。

* **イメージビルド (Docker Build)**
    * **ターゲット**: DataChain, MetaChain, Relayer の選択（UIのみ）。
    * **オプション**: 「キャッシュなし (No Cache)」チェックボックス。
    * **実行**: ビルドプロセスを模したログを出力し、完了後に `isDockerBuilt` フラグを更新。
* **クラスタデプロイ (Cluster Deploy)**
    * **スケーリング**: スライダーによりDataChainノード数（1〜10）を設定。
    * **バリデーション**: Dockerイメージ未ビルド時は警告を表示し、操作をロック。
    * **実行**: Helmコマンドの実行ログを出力し、完了後に `deployedNodeCount` を更新。
    * **リセット**: 環境を全削除（`deployedNodeCount = 0`）する機能。
* **コンソール出力 (Console)**
    * **UI**: Macのウィンドウ制御ボタン（赤・黄・緑）を模したヘッダーデザイン。
    * **機能**: 操作ログをリアルタイム表示し、自動スクロール。

### ③ Economy Layer (経済圏・アカウント管理)
トークンエコノミーとシステム維持費の管理を行います。

* **Watchdog 制御**
    * **スイッチ**: Relayer残高監視機能のON/OFF切り替え。
    * **履歴パネル**: Watchdogによる自動給付（Faucet）の実行履歴ログを表示。
* **アカウント管理リスト**
    * **アコーディオンUI**: 「システムアカウント」「ユーザーアカウント」の各セクションはヘッダーをクリックして折りたたみ/展開が可能。
    * **ユーザーアカウント**: アドレス、残高を表示。Faucet（給付）と削除が可能。
    * **システムアカウント**: Millionaire（Pool）と各Relayerを表示。Relayerへの手動Faucetも可能。
* **秘密鍵表示 (Private Key Viewer)**
    * **モーダル**: ユーザーのアドレス横の鍵アイコンから起動。
    * **機能**: 擬似的なMnemonicフレーズを表示し、クリップボードへのコピーが可能。

### ④ Scenario Layer (シナリオ管理)
保存された実験設定を管理します。

* **シナリオリスト**
    * **カード表示**: シナリオ名、更新日時、プロジェクト名、設定概要（Allocator/Transmitter/Type）を表示。
    * **削除**: 削除アイコンから確認ダイアログを経て削除。
* **詳細パネル**
    * **スライド表示**: リストで選択したシナリオの詳細設定（仮想/実データ構成、ターゲットチェーン一覧など）を右側パネルに表示。
    * **閉じる**: 閉じるボタンまたは別のシナリオ選択で切り替え。

### ⑤ Experiment Layer (実験実行)
実験の構成、シミュレーション、実行を行う中核画面です。

* **レイアウト**
    * **メインエリア**: 設定フォーム。
    * **アクションパネル（右側）**: コスト試算や実行ボタンを集約したドロワー。`<` `>` ボタンで開閉可能。
* **設定フォーム (Config)**
    * **基本設定**: 実行アカウント、Allocator、Transmitterを選択。ターゲットチェーンは個別選択または「全選択/解除」が可能。
    * **データ設定**:
        * **Virtual (仮想)**: 合計サイズ(MB)、チャンクサイズ(KB)、ファイル数を指定。
        * **Real (実ファイル)**: ファイル/フォルダのドラッグ＆ドロップまたはダイアログ選択。Zipファイル対応。
            * **Tree Preview**: アップロードされたファイル構造を解析し、ASCIIアート形式のツリービューを生成して表示。
    * **プロジェクト名**: 仮想データ時は手動入力、実ファイル時はファイル名から自動補完（編集可能）。
* **アクションパネル**
    * **コスト試算**: データサイズとチェーン数からコストを計算。残高不足時はエラーを表示し実行をブロック。
    * **設定読み込み**: 保存済みシナリオを選択してロード。
        * **※制約事項**: 「Real」設定のロード時、ブラウザのセキュリティ制約によりファイル実体は復元できないため、「設定のみ復元し、ファイル再選択が必要」である旨を通知。
    * **保存**: 現在の設定に名前を付けてシナリオとして保存。
    * **障害シミュレーション**: 実験を意図的に失敗させるフラグのON/OFF。
    * **実行 (Run)**: 実験を開始。
* **実行モニター (Active Experiment Banner)**
    * **表示**: 実験実行中、画面上部にバナーが出現。
    * **内容**: 進捗プログレスバー、現在のステータスメッセージ、パーセンテージ。
    * **ログ**: 「詳細ログを表示」ボタンでログモーダルを展開。

### ⑥ Library Layer (結果アーカイブ)
過去の実験結果を蓄積・分析します。

* **検索・フィルタリング**
    * **検索バー**: シナリオ名または実験ID（部分一致）で検索。
    * **詳細フィルター**: 「フィルター追加」ボタンからドロップダウンで条件（Status, Allocator, Transmitter）を選択・追加。
    * **バッジ表示**: 適用中のフィルターをバッジとして表示し、個別に削除可能。
* **結果テーブル**
    * **カラム**: 実行ID/日時, シナリオ名, ステータス, 戦略, データサイズ, スループット。
    * **ソート**: ヘッダー昇順/降順ソート。
    * **行選択**: クリックで選択状態（ハイライト）にし、アクションボタンを表示。
* **詳細モーダル (Detail View)**
    * **概要**: ステータス、日時、ID。
    * **設定**: データサイズ、チャンクサイズ、総Tx数、戦略。
    * **インフラ**: 使用チェーン数、チェーンID一覧。
    * **パフォーマンス**: アップロード時間、ダウンロード時間、スループット（強調表示）。
* **データエクスポート**
    * **モーダル**: 選択した行に対してエクスポート設定を行う。
    * **設定**: 出力ファイル名の編集、フォーマット選択（CSV / JSON）。
    * **プレビュー**: 出力内容のプレビュー表示。
    * **アクション**: 「コピー（クリップボード）」または「ダウンロード（ファイル保存）」。

---

## 4. シミュレーションロジック (Internal Logic)

WebUIはバックエンドとの通信を行わず、以下のロジックでControllerの挙動を模倣します。

1.  **スループット計算**: `(データサイズMB * 1024 * 1024 * 8) / (アップロード所要時間秒)` で算出。
2.  **コストモデル**: `(データサイズMB * 2.5) + (ターゲットチェーン数 * 100)` TKN として計算。
3.  **ログ生成**: `setInterval` を使用し、進捗％に応じて `Splitting...` -> `Broadcasting...` -> `Verifying...` と遷移するログを生成。
4.  **ファイルツリー生成**: 実ファイルの `webkitRelativePath` またはファイル名を解析し、階層構造を持つオブジェクトに変換後、ASCIIアート文字列としてレンダリング。