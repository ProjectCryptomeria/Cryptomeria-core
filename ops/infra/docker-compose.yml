version: '3.8'

x-chain-common: &chain-common
  # ベースイメージは各サービスの build/image 設定で上書きされます
  image: ubuntu:22.04
  # コンテナ内のパスを指定 (/scripts はボリュームマウントされているため)
  entrypoint: /scripts/entrypoint-chain.sh
  volumes:
    - ./scripts:/scripts:ro
    - ./mnemonics:/etc/mnemonics:ro
  environment:
    - DEV_MODE=true
    - OUTPUT=json
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:26657/status"]
    interval: 5s
    timeout: 5s
    retries: 10
    start_period: 10s

services:
  # ===========================================================================
  # Chains
  # ===========================================================================
  gwc:
    <<: *chain-common
    image: raidchain/gwc:latest
    build:
      context: .
      dockerfile: build/gwc/Dockerfile
    container_name: gwc
    hostname: gwc
    environment:
      - CHAIN_INSTANCE_NAME=gwc
      - CHAIN_APP_NAME=gwc
      # 他のチェーンへのエンドポイント定義 (Docker DNS)
      - MDSC_ENDPOINT=http://mdsc:1317
      - FDSC_0_ENDPOINT=http://fdsc-0:1317
    volumes:
      - ./data/gwc:/home/gwc/.gwc
      - ./scripts:/scripts:ro
      - ./mnemonics:/etc/mnemonics:ro
    ports:
      - "30067:1317"  # API
      - "30057:26657" # RPC
      - "9090:9090"   # gRPC

  mdsc:
    <<: *chain-common
    image: raidchain/mdsc:latest
    build:
      context: .
      dockerfile: build/mdsc/Dockerfile
    container_name: mdsc
    hostname: mdsc
    environment:
      - CHAIN_INSTANCE_NAME=mdsc
      - CHAIN_APP_NAME=mdsc
    volumes:
      - ./data/mdsc:/home/mdsc/.mdsc
      - ./scripts:/scripts:ro
      - ./mnemonics:/etc/mnemonics:ro
    ports:
      - "26658:26657" # RPC
      - "1318:1317"   # API

  fdsc-0:
    <<: *chain-common
    image: raidchain/fdsc:latest
    build:
      context: .
      dockerfile: build/fdsc/Dockerfile
    container_name: fdsc-0
    hostname: fdsc-0
    environment:
      - CHAIN_INSTANCE_NAME=fdsc-0
      - CHAIN_APP_NAME=fdsc
    volumes:
      - ./data/fdsc-0:/home/fdsc/.fdsc
      - ./scripts:/scripts:ro
      - ./mnemonics:/etc/mnemonics:ro
    ports:
      - "26659:26657" # RPC
      - "1319:1317"   # API

  # ===========================================================================
  # Relayer
  # ===========================================================================
  relayer:
    image: raidchain/relayer:latest
    build:
      context: .
      dockerfile: build/relayer/Dockerfile
    container_name: relayer
    hostname: relayer
    entrypoint: /scripts/init-relayer.sh
    environment:
      # Docker Composeのサービス名(ホスト名)を指定
      - CHAIN_NAMES_CSV=gwc,mdsc,fdsc-0
    volumes:
      - ./data/relayer:/home/relayer/.relayer
      - ./scripts:/scripts:ro
      - ./mnemonics:/etc/relayer/mnemonics:ro
    depends_on:
      gwc:
        condition: service_healthy
      mdsc:
        condition: service_healthy
      fdsc-0:
        condition: service_healthy

  # ===========================================================================
  # Post-Init Jobs (Registrar)
  # ===========================================================================
  registrar:
    # GWCと同じイメージを使用 (gwcサービスでビルドされたものを使う)
    image: raidchain/gwc:latest
    container_name: registrar
    entrypoint: /scripts/init-registrar.sh
    environment:
      - GWC_ID=gwc
      - CHAIN_NAMES_CSV=gwc,mdsc,fdsc-0
      - RPC_NODE=http://gwc:26657
    volumes:
      - ./scripts:/scripts:ro
      - ./mnemonics:/etc/mnemonics:ro
    depends_on:
      gwc:
        condition: service_healthy
      relayer:
        condition: service_started