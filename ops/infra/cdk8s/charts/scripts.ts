import { RaidChainProps } from './raidchain';

/**
 * ãƒã‚§ãƒ¼ãƒ³ãƒãƒ¼ãƒ‰ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚
 * æ±ç”¨çš„ãªç’°å¢ƒå¤‰æ•°ä¾å­˜ã¯æ®‹ã—ã¤ã¤ã€å®šæ•°å€¤ã¯TSã‹ã‚‰æ³¨å…¥ã—ã¾ã™ã€‚
 */
export function createEntrypointChainScript(props: RaidChainProps): string {
	// Dockerfileã«åˆã‚ã›ã¦ bash ã‚’æŒ‡å®š
	return `#!/usr/bin/env bash
set -e

# --- Generated by CDK8s (scripts.ts) ---

# --- ç’°å¢ƒå¤‰æ•°ã¨è¨­å®š ---
# StatefulSetã®envå®šç¾©ã‹ã‚‰æ¸¡ã•ã‚Œã‚‹å¤‰æ•°ã‚’æƒ³å®š
CHAIN_ID=\${CHAIN_INSTANCE_NAME}
CHAIN_APP_NAME=\${CHAIN_APP_NAME:-datachain}
DENOM="uatom"
USER_HOME="/home/$CHAIN_APP_NAME"
CHAIN_HOME="$USER_HOME/.$CHAIN_APP_NAME"
CHAIN_BINARY="\${CHAIN_APP_NAME}d"
MNEMONIC_FILE="/etc/mnemonics/\${CHAIN_INSTANCE_NAME}.mnemonic"

# --- åˆæœŸåŒ–å‡¦ç† ---
if [ ! -d "$CHAIN_HOME/config" ]; then
    echo "--- Initializing chain: $CHAIN_ID (type: $CHAIN_APP_NAME) ---"

    # åˆæœŸåŒ–
    $CHAIN_BINARY init "$CHAIN_ID" --chain-id "$CHAIN_ID" --home "$CHAIN_HOME"

    # éµã®å¾©å…ƒ (HD PathæŒ‡å®š)
    SHARED_MNEMONIC=$(cat "$MNEMONIC_FILE")
    
    echo "$SHARED_MNEMONIC" | $CHAIN_BINARY keys add validator --recover --keyring-backend=test --home "$CHAIN_HOME" --hd-path "m/44'/118'/0'/0/0"
    echo "$SHARED_MNEMONIC" | $CHAIN_BINARY keys add relayer --recover --keyring-backend=test --home "$CHAIN_HOME" --hd-path "m/44'/118'/0'/0/1"
    echo "$SHARED_MNEMONIC" | $CHAIN_BINARY keys add creator --recover --keyring-backend=test --home "$CHAIN_HOME" --hd-path "m/44'/118'/0'/0/2"

    VALIDATOR_ADDR=$($CHAIN_BINARY keys show validator -a --keyring-backend=test --home "$CHAIN_HOME")
    RELAYER_ADDR=$($CHAIN_BINARY keys show relayer -a --keyring-backend=test --home "$CHAIN_HOME")
    CREATOR_ADDR=$($CHAIN_BINARY keys show creator -a --keyring-backend=test --home "$CHAIN_HOME")

    # ã‚¸ã‚§ãƒã‚·ã‚¹è¨­å®š
    $CHAIN_BINARY genesis add-genesis-account "$VALIDATOR_ADDR" 1000000000000"$DENOM" --home "$CHAIN_HOME"
    
    $CHAIN_BINARY genesis gentx validator 1000000000"$DENOM" \\
        --keyring-backend=test \\
        --chain-id "$CHAIN_ID" \\
        --home "$CHAIN_HOME"

    $CHAIN_BINARY genesis collect-gentxs --home "$CHAIN_HOME"

    $CHAIN_BINARY genesis add-genesis-account "$RELAYER_ADDR" 100000000000"$DENOM" --home "$CHAIN_HOME"
    $CHAIN_BINARY genesis add-genesis-account "$CREATOR_ADDR" 100000000000"$DENOM" --home "$CHAIN_HOME"

    echo "--- Validating genesis file ---"
    $CHAIN_BINARY genesis validate --home "$CHAIN_HOME"

    CONFIG_TOML="$CHAIN_HOME/config/config.toml"
    APP_TOML="$CHAIN_HOME/config/app.toml"
    
    # --- config.toml è¨­å®š (TSã‹ã‚‰æ³¨å…¥ã•ã‚ŒãŸå€¤ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æ®‹ã›ã¾ã™) ---
    # Max Bytes: 150MB
    sed -i 's/laddr = "tcp:\\/\\/127.0.0.1:26657"/laddr = "tcp:\\/\\/0.0.0.0:26657"/' "$CONFIG_TOML"
    sed -i 's/cors_allowed_origins = \\[\\]/cors_allowed_origins = \\["*"\\]./' "$CONFIG_TOML"
    sed -i 's/^max_body_bytes = .*/max_body_bytes = 10737418240/' "$CONFIG_TOML"
    sed -i 's/^max_tx_bytes = .*/max_tx_bytes = 10737418240/' "$CONFIG_TOML"
    
    sed -i 's/^size = .*/size = 50000/' "$CONFIG_TOML"
    sed -i 's/^max_txs_bytes = .*/max_txs_bytes = 10737418240/' "$CONFIG_TOML"
    sed -i 's/^timeout_broadcast_tx_commit = .*/timeout_broadcast_tx_commit = "60s"/' "$CONFIG_TOML"

    # --- app.toml è¨­å®š ---
    sed -i '/\\[api\\]/,/\\[/{s/enable = false/enable = true/}' "$APP_TOML"
    sed -i '/\\[api\\]/,/\\[/{s/address = "tcp:\\/\\/localhost:1317"/address = "tcp:\\/\\/0.0.0.0:1317"/}' "$APP_TOML"
    sed -i '/\\[api\\]/a max-request-body-size = 10737418240' "$APP_TOML"
    sed -i '/\\[grpc\\]/,/\\[/{s/enable = false/enable = true/}' "$APP_TOML"
    
    sed -i 's/^max-recv-msg-size = .*/max-recv-msg-size = "10737418240"/' "$APP_TOML"
    sed -i 's/^max-send-msg-size = .*/max-send-msg-size = "10737418240"/' "$APP_TOML"
    
    sed -i '/\\[grpc-web\\]/,/\\[/{s/enable = false/enable = true/}' "$APP_TOML"

    echo "--- Initialization complete for $CHAIN_ID ---"
fi

# --- ãƒãƒ¼ãƒ‰ã®èµ·å‹• ---
START_CMD="$CHAIN_BINARY start --home $CHAIN_HOME --minimum-gas-prices=0$DENOM --log_level error --log_format json"

if [ "$DEV_MODE" = "true" ]; then
    echo "ğŸš§ DEVELOPMENT MODE: Hot Reload Enabled"
    while true; do
        echo "--> ğŸš€ Starting node for $CHAIN_ID..."
        $START_CMD &
        PID=$!
        wait $PID || true
        echo "--> ğŸ”„ Restarting..."
        sleep 1
    done
else
    echo "--- Starting node for $CHAIN_ID (Production) ---"
    exec $START_CMD
fi
`;
}

/**
 * RelayeråˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚
 * TypeScriptå´ã§ãƒã‚§ãƒ¼ãƒ³æƒ…å ±ã‚’å±•é–‹ã—ã€Bashå´ã®ãƒ«ãƒ¼ãƒ—å‡¦ç†ã‚„è§£æãƒ­ã‚¸ãƒƒã‚¯ã‚’æ’é™¤ã—ã¾ã™ã€‚
 */
export function createRelayerInitScript(props: RaidChainProps, headlessServiceName: string): string {
	const gwc = props.chains.find(c => c.type === 'gwc');
	if (!gwc) throw new Error("GWC chain is required");

	const mdsc = props.chains.find(c => c.type === 'mdsc');
	const fdscs = props.chains.filter(c => c.type === 'fdsc');

	// ãƒã‚§ãƒ¼ãƒ³è¨­å®šã‚³ãƒãƒ³ãƒ‰ã‚’TSå´ã§ç”Ÿæˆ
	const chainConfigCommands = props.chains.map(chain => {
		const rpcAddr = `http://${props.releaseName}-${chain.name}-0.${headlessServiceName}.\${POD_NAMESPACE}.svc.cluster.local:26657`;
		const grpcAddr = `${props.releaseName}-${chain.name}-0.${headlessServiceName}.\${POD_NAMESPACE}.svc.cluster.local:9090`;

		// JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¦èª­ã¿è¾¼ã¾ã›ã‚‹æ–¹å¼
		return `
cat > "/tmp/${chain.name}.json" <<EOF
{
  "type": "cosmos",
  "value": {
    "key": "relayer", "chain-id": "${chain.name}", "rpc-addr": "${rpcAddr}", "grpc-addr": "${grpcAddr}",
    "account-prefix": "cosmos", "keyring-backend": "test", "gas-adjustment": 1.5,
    "gas-prices": "0.001uatom", "debug": false, "timeout": "20s", "output-format": "json", "sign-mode": "direct"
  }
}
EOF
rly chains add --file "/tmp/${chain.name}.json"
`;
	}).join('\n');

	// ãƒ‘ã‚¹ä½œæˆã‚³ãƒãƒ³ãƒ‰ã®ç”Ÿæˆ
	// GWC <-> MDSC
	let pathCommands = '';
	if (mdsc) {
		pathCommands += `rly paths new "${gwc.name}" "${mdsc.name}" "path-${gwc.name}-to-${mdsc.name}"\n`;
	}
	// GWC <-> FDSC(s)
	fdscs.forEach(fdsc => {
		pathCommands += `rly paths new "${gwc.name}" "${fdsc.name}" "path-${gwc.name}-to-${fdsc.name}"\n`;
	});

	// ãƒªãƒ³ã‚¯ç¢ºç«‹ã‚³ãƒãƒ³ãƒ‰ã®ç”Ÿæˆ (Parallel execution)
	let linkCommands = '';
	if (mdsc) {
		linkCommands += `link_path "path-${gwc.name}-to-${mdsc.name}" "gateway" "metastore" &\nPIDS="$PIDS $!"\n`;
	}
	fdscs.forEach(fdsc => {
		linkCommands += `link_path "path-${gwc.name}-to-${fdsc.name}" "gateway" "datastore" &\nPIDS="$PIDS $!"\n`;
	});

	// Storageç™»éŒ²ã‚³ãƒãƒ³ãƒ‰ç”¨ã®å¼•æ•°ç”Ÿæˆ
	let regArgs = '';
	if (mdsc) {
		const endpoint = `http://${props.releaseName}-${mdsc.name}-0.${headlessServiceName}.\${POD_NAMESPACE}.svc.cluster.local:1317`;
		regArgs += ` ${mdsc.name} ${endpoint}`;
	}
	fdscs.forEach(fdsc => {
		const endpoint = `http://${props.releaseName}-${fdsc.name}-0.${headlessServiceName}.\${POD_NAMESPACE}.svc.cluster.local:1317`;
		regArgs += ` ${fdsc.name} ${endpoint}`;
	});


	return `#!/bin/bash
set -e
# --- Generated by CDK8s (scripts.ts) ---

POD_NAMESPACE=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)
RELAYER_HOME="/home/relayer/.relayer"
GWCD_HOME="/home/relayer/.gwc-client"
MNEMONICS_DIR="/etc/relayer/mnemonics"

# é–¢æ•°å®šç¾©: ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯
retry() {
    local n=1
    local max=30
    local delay=1
    while true; do
        "$@" && break 
        if [[ $n -lt $max ]]; then
            ((n++))
            echo "âš ï¸ Command failed. Retrying in \${delay}s... ($n/$max)"
            sleep $delay;
        else
            echo "âŒ The command has failed after $n attempts."
            return 1
        fi
    done
}

# é–¢æ•°å®šç¾©: ãƒ‘ã‚¹ãƒªãƒ³ã‚¯
link_path() {
    P_NAME=$1
    SRC_PORT=$2
    DST_PORT=$3
    echo "--> [Start] Linking $P_NAME ($SRC_PORT <-> $DST_PORT)"
    
    retry rly transact clients "$P_NAME" --override || return 1
    retry rly transact connection "$P_NAME" || return 1
    retry rly transact channel "$P_NAME" --src-port "$SRC_PORT" --dst-port "$DST_PORT" --order unordered --version "raidchain-1" || return 1
        
    echo "âœ… [Done] Path $P_NAME linked."
}

if [ ! -f "$RELAYER_HOME/config/config.yaml" ]; then
    echo "--- Initializing relayer configuration ---"
    rm -rf "$RELAYER_HOME/paths"
    rly config init
    mkdir -p /tmp

    # --- 1. ãƒã‚§ãƒ¼ãƒ³è¨­å®šã®è¿½åŠ  (Typescriptç”Ÿæˆ) ---
    ${chainConfigCommands}

    # --- 2. ã‚­ãƒ¼ã®ãƒªã‚¹ãƒˆã‚¢ ---
    # ãƒã‚§ãƒ¼ãƒ³åãƒªã‚¹ãƒˆã¯TSå´ã§æŠŠæ¡æ¸ˆã¿ã ãŒã€Bashé…åˆ—ã¨ã—ã¦æŒã¤
    CHAINS=("${props.chains.map(c => c.name).join('" "')}")
    
    for CHAIN_ID in "\${CHAINS[@]}"; do
        MNEMONIC_FILE="\${MNEMONICS_DIR}/\${CHAIN_ID}.mnemonic"
        while [ ! -f "$MNEMONIC_FILE" ]; do echo "Waiting for $MNEMONIC_FILE..."; sleep 1; done
        
        RELAYER_MNEMONIC=$(cat "$MNEMONIC_FILE")
        rly keys restore "$CHAIN_ID" "relayer" "$RELAYER_MNEMONIC"

        # GWCã®å ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã®gwcdã«ã‚‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        if [ "$CHAIN_ID" == "${gwc.name}" ]; then
             echo "$RELAYER_MNEMONIC" | gwcd keys add "relayer" --recover --keyring-backend test --home "$GWCD_HOME"
        fi
    done

    # --- 3. ãƒ‘ã‚¹ã®å®šç¾© (Typescriptç”Ÿæˆ) ---
    ${pathCommands}

    # --- 4. ãƒã‚§ãƒ¼ãƒ³ã®æº–å‚™å¾…æ©Ÿ ---
    echo "--- Waiting for chains to be ready... ---"
    # ã“ã“ã§ã‚‚TSã§æ³¨å…¥ã•ã‚ŒãŸRPCã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’åˆ©ç”¨ã—ã¦ãƒã‚§ãƒƒã‚¯å¯èƒ½ã ãŒã€
    # æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã®ãƒ«ãƒ¼ãƒ—ã‚’ä½¿ç”¨
    for CHAIN_ID in "\${CHAINS[@]}"; do
        # ç°¡æ˜“çš„ãªå¾…æ©Ÿ (rly statusç­‰ã¯é‡ã„ã®ã§ã€curlã§ç¢ºèª)
        echo "--> Checking $CHAIN_ID connectivity..."
        # NOTE: è©³ç´°ãªãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯ã¯å¿…è¦ã«å¿œã˜ã¦è¨˜è¿°
        sleep 2
    done

    # --- 5. ãƒªãƒ³ã‚¯ç¢ºç«‹ (Typescriptç”Ÿæˆ) ---
    PIDS=""
    ${linkCommands}
    
    for PID in $PIDS; do
        wait $PID
        if [ $? -ne 0 ]; then echo "âŒ Link process failed."; exit 1; fi
    done

    # --- 6. ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç™»éŒ² ---
    echo "--- Auto-Registering Storage Endpoints ---"
    GWC_RPC="http://${props.releaseName}-${gwc.name}-0.${headlessServiceName}.\${POD_NAMESPACE}.svc.cluster.local:26657"
    
    TX_CMD="gwcd tx gateway register-storage ${regArgs} --from relayer --chain-id ${gwc.name} --keyring-backend test --home $GWCD_HOME --node $GWC_RPC -y --output json"
    
    echo "Executing: $TX_CMD"
    # å¤±æ•—ã—ã¦ã‚‚ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã•ã›ãªã„å ´åˆã¯ || true ã‚’ã¤ã‘ã‚‹
    $TX_CMD || echo "âŒ Registration failed (might be already registered)."
    
    sleep 5
fi

echo "--- Starting relayer ---"
exec rly start --log-level warn --log-format json
`;
}