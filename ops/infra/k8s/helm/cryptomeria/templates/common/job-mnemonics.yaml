{{- if not .Values.staticMnemonics.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "cryptomeria.fullname" . }}-mnemonic-generator
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": "pre-install,pre-upgrade"
    "helm.sh/hook-delete-policy": "before-hook-creation,hook-succeeded"
    "helm.sh/hook-weight": "0"
spec:
  template:
    spec:
      serviceAccountName: {{ include "cryptomeria.fullname" . }}-sa
      restartPolicy: Never
      containers:
        - name: generator
          image: "node:22-alpine"
          imagePullPolicy: IfNotPresent
          command:
            - /bin/sh
            - -c
            - |
              set -ex

              SECRET_NAME="{{ include "cryptomeria.fullname" . }}-mnemonics"
              SECRET_FILE="/tmp/secret.yaml"
              
              echo "--- Installing dependencies for mnemonic generation ---"
              apk add --no-cache kubectl
              corepack enable
              yarn add @cosmjs/proto-signing

              echo "--- Generating mnemonics via Node.js (@cosmjs/crypto) ---"

              cat <<EOF > ${SECRET_FILE}
              apiVersion: v1
              kind: Secret
              metadata:
                name: ${SECRET_NAME}
                namespace: {{ .Release.Namespace }}
              type: Opaque
              stringData:
              EOF
              
              # 注: 以下は古い .Values.chains 構造に依存しているため、
              # 動的生成を再度有効にする場合はここも新しい構造に合わせて修正する必要があります。
              # 現在は enabled: false なのでスキップされます。

              echo "--- Applying Secret to the cluster ---"
              kubectl apply -f ${SECRET_FILE}
              echo "--- Secret '${SECRET_NAME}' created/updated successfully ---"
  backoffLimit: 1
{{- end }}