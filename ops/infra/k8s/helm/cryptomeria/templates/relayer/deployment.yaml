apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "cryptomeria.fullname" . }}-relayer
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "cryptomeria.labels" . | nindent 4 }}
    app.kubernetes.io/component: relayer
spec:
  replicas: {{ .Values.relayer.replicaCount }}
  selector:
    matchLabels:
      {{- include "cryptomeria.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: relayer
  template:
    metadata:
      labels:
        {{- include "cryptomeria.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: relayer
    spec:
      containers:
        - name: relayer
          image: "{{ .Values.relayer.image.repository }}:{{ .Values.relayer.image.tag }}"
          imagePullPolicy: {{ .Values.relayer.image.pullPolicy }}
          # 無限ループで待機 (外部スクリプトからの制御待ち)
          # 修正: SIGTERM即時終了のために trap と wait を使用
          command: ["/bin/sh", "-c"]
          args: ["trap 'exit 0' TERM; while :; do sleep 3600 & wait $!; done"]
          volumeMounts:
            - name: data
              mountPath: /home/relayer/.relayer
            - name: config
              mountPath: /home/relayer/.relayer/config
            # ▼ 追加: ニーモニックSecretを読み取り専用でマウント
            - name: mnemonics
              mountPath: /etc/mnemonics
              readOnly: true
          resources:
            {{- toYaml .Values.relayer.resources | nindent 12 }}
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: {{ include "cryptomeria.fullname" . }}-relayer-data
        - name: config
          emptyDir: {}
        # ▼ 追加: Secret定義
        - name: mnemonics
          secret:
            secretName: {{ include "cryptomeria.fullname" . }}-mnemonics