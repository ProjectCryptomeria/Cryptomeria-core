{{- if .Values.faucet.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: faucet-source
  namespace: {{ .Values.global.namespace }}
data:
  package.json: |
    {
      "name": "faucet",
      "type": "module",
      "version": "1.0.0",
      "description": "Faucet for Cosmos-SDK blockchains",
      "main": "faucet.js",
      "scripts": {
        "start": "node --experimental-modules --es-module-specifier-resolution=node faucet.js"
      },
      "dependencies": {
        "@cosmjs/crypto": "^0.29.4",
        "@cosmjs/proto-signing": "^0.29.4",
        "@cosmjs/stargate": "^0.29.4",
        "express": "^4.18.2",
        "level": "^8.0.0",
        "cors": "^2.8.5"
      }
    }
  # ------------------------------------------------------------------
  # 2. checker.js
  # ------------------------------------------------------------------
  checker.js: |
    import { Level } from "level";
    const WINDOW = 86400 * 1000 
    export class FrequencyChecker {
        constructor(conf) {
            this.conf = conf
            this.db = new Level(conf.db.path, { valueEncoding: 'json' });
        }
        async check(key, limit) {
            return new Promise((resolve) => {
                this.db.get(key, function (err, value) {
                    const now = Date.now()
                    if (err || value && value.filter(x => now - x < WINDOW).length < limit) {
                        resolve(true)
                    } else {
                        resolve(false)
                    }
                });
            })
        }
        async checkIp(ip) { return this.check(ip, this.conf.limit.ip) }
        async checkAddress(address) { return this.check(address, this.conf.limit.address) }
        async update(key) {
            const db = this.db
            db.get(key, function (err, history) {
                if (err) { db.put(key, [Date.now()]) } 
                else { history.push(Date.now()); db.put(key, history) }
            });
        }
    }

  # ------------------------------------------------------------------
  # 3. faucet.js
  # ------------------------------------------------------------------
  faucet.js: |
    import express from 'express';
    import cors from 'cors';
    import * as path from 'path'
    import { DirectSecp256k1HdWallet } from "@cosmjs/proto-signing";
    import { SigningStargateClient } from "@cosmjs/stargate";
    import { FrequencyChecker } from './checker.js';
    import conf from './config.js'

    console.log("loaded config: ", conf)
    const app = express()
    
    // ✅ CORSを許可
    app.use(cors());
    // ✅ JSONボディを解析可能にする
    app.use(express.json());

    const checker = new FrequencyChecker(conf)

    app.get('/', async (req, res) => { res.send(conf.project); })

    // ✅ フロントエンドの POST リクエストに対応
    app.post('/', async (req, res) => {
      const { address } = req.body;
      console.log('POST: request tokens to ', address)
      if (!address) {
          return res.status(400).send({ result: 'address is required' });
      }
      try {
          const ret = await sendTx(address);
          res.send({ result: ret });
      } catch (err) {
          console.error(err);
          res.status(500).send({ result: 'Failed: ' + err.toString() });
      }
    });

    app.get('/send/:address', async (req, res) => {
      const {address} = req.params;
      console.log('GET: request tokens to ', address, req.ip)
      if (address) {
        try {
          if (address.startsWith(conf.sender.option.prefix)) {
              sendTx(address).then(ret => {
                console.log('sent tokens to ', address)
                res.send({ result: ret })
              }).catch(err => {
                 console.error(err);
                 res.send({ result: 'Failed: ' + err.toString() })
              });
          } else {
            res.send({ result: `Address [${address}] is not supported.` })
          }
        } catch (err) {
          console.error(err);
          res.send({ result: 'Failed, Please contact to admin.' })
        }
      } else {
        res.send({ result: 'address is required' });
      }
    })

    app.listen(conf.port, () => { console.log(`Faucet app listening on port ${conf.port}`) })

    async function sendTx(recipient) {
      const wallet = await DirectSecp256k1HdWallet.fromMnemonic(conf.sender.mnemonic, conf.sender.option);
      const [firstAccount] = await wallet.getAccounts();
      const rpcEndpoint = conf.blockchain.rpc_endpoint;
      const client = await SigningStargateClient.connectWithSigner(rpcEndpoint, wallet);
      const amount = conf.tx.amount;
      const fee = conf.tx.fee;
      return client.sendTokens(firstAccount.address, recipient, [amount], fee);
    }

  # ------------------------------------------------------------------
  # 4. config.js
  # ------------------------------------------------------------------
  config.js: |
    import { stringToPath } from '@cosmjs/crypto'
    export default {
        port: 4500,
        db: { path: "./db/faucet.db" },
        project: { name: "Cryptomeria Faucet" },
        blockchain: {
            rpc_endpoint: "{{ .Values.faucet.chain.rpc }}",
        },
        sender: {
            mnemonic: "MNEMONIC_PLACEHOLDER",
            option: {
                hdPaths: [stringToPath("m/44'/{{ .Values.faucet.chain.coinType }}'/0'/0/0")],
                prefix: "{{ .Values.faucet.chain.prefix }}"
            }
        },
        tx: {
            amount: {
                denom: "{{ .Values.faucet.chain.denom }}",
                amount: "{{ .Values.faucet.chain.maxCredit }}"
            },
            fee: {
                amount: [{ amount: "2000", denom: "{{ .Values.faucet.chain.denom }}" }],
                gas: "200000"
            },
        },
        limit: { address: 100, ip: 100 }
    }
{{- end }}