{{- if .Values.faucet.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: faucet
  namespace: {{ .Values.global.namespace }}
  labels:
    app: faucet
spec:
  replicas: 1
  selector:
    matchLabels:
      app: faucet
  template:
    metadata:
      labels:
        app: faucet
    spec:
      containers:
        - name: faucet
          image: node:20-alpine
          imagePullPolicy: IfNotPresent
          workingDir: /app
          command: ["/bin/sh", "-c"]
          args:
            - |
              echo "ğŸš€ Setting up Faucet from ConfigMap..." && \
              # ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«ã®è¿½åŠ 
              apk add --no-cache python3 make g++ && \
              mkdir -p /app/db && \
              cp /src/* /app/ && \
              echo "ğŸ”‘ Injecting mnemonic..." && \
              sed -i "s/MNEMONIC_PLACEHOLDER/$MNEMONIC/g" /app/config.js && \
              echo "ğŸ“¦ Installing dependencies..." && \
              npm install --quiet && \
              echo "âœ… Starting Faucet..." && \
              # exec ã‚’ä½¿ç”¨ã—ã¦ã€Node.jsãƒ—ãƒ­ã‚»ã‚¹ãŒã‚·ã‚°ãƒŠãƒ«(SIGTERM)ã‚’ç›´æ¥å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ä¿®æ­£
              exec npm start
          ports:
            - containerPort: 4500
          env:
            - name: MNEMONIC
              valueFrom:
                secretKeyRef:
                  name: cryptomeria-mnemonics
                  key: gwc.local-admin.mnemonic
          volumeMounts:
            - name: src-volume
              mountPath: /src
      volumes:
        - name: src-volume
          configMap:
            name: faucet-source
{{- end }}